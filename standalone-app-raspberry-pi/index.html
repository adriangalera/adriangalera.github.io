<!DOCTYPE html><html lang="en" class="scroll-smooth" data-astro-cid-37fxchfa> <head><!-- ViewTransitions  --><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><script type="module" src="/_astro/ClientRouter.astro_astro_type_script_index_0_lang.CMTcOisY.js"></script> <!-- Global Metadata --> <meta charset="utf-8"> <meta name="viewport" content="width=device-width,initial-scale=1"> <link rel="icon" type="image/svg+xml" href="/favicon.svg"> <meta name="generator" content="Astro v5.5.4"> <!-- Canonical URL --> <link rel="canonical" href="https://www.agalera.eu/standalone-app-raspberry-pi/"> <!-- SEO --> <meta name="title" content="Standalone application for Raspberry Pi • agalera.eu"> <meta name="description" content="The design, implementation and continuous integration of a standalone application to be run on a Raspberry Pi."> <meta name="author" content="Adrian Galera"> <!-- Open Graph / Facebook --> <meta property="og:type" content="article"> <meta property="og:url" content="https://www.agalera.eu/standalone-app-raspberry-pi/"> <meta property="og:title" content="Standalone application for Raspberry Pi"> <meta property="og:description" content="The design, implementation and continuous integration of a standalone application to be run on a Raspberry Pi."> <meta property="og:image" content="https://www.agalera.eu/_astro/featured-image.QCGhLc11.jpg">  <meta property="article:author" content="Adrian Galera"> <meta property="article:published_time" content="2021-02-18T00:00:00.000Z">  <!-- Twitter --> <meta property="twitter:card" content="summary_large_image"> <meta property="twitter:url" content="https://www.agalera.eu/standalone-app-raspberry-pi/"> <meta property="twitter:title" content="Standalone application for Raspberry Pi"> <meta property="twitter:description" content="The design, implementation and continuous integration of a standalone application to be run on a Raspberry Pi."> <meta property="twitter:image" content="https://www.agalera.eu/_astro/featured-image.QCGhLc11.jpg"> <!-- RSS auto-discovery --> <link rel="alternate" type="application/rss+xml" title="agalera.eu" href="/rss.xml"> <!-- Google tag (gtag.js) --> <script async src="https://www.googletagmanager.com/gtag/js?id=G-S8VGYBN25C"></script> <script type="module">const n=window.location.hostname;n.includes("agalera.eu")||(console.log("Disabling analytics..."),window["ga-disable-G-S8VGYBN25C"]=!0);window.dataLayer=window.dataLayer||[];function a(){dataLayer.push(arguments)}a("js",new Date);a("config","G-S8VGYBN25C");</script> <!-- Primary Meta Tags --> <title>Standalone application for Raspberry Pi • agalera.eu</title><script>
	function getTheme() {
		const storedTheme = typeof localStorage !== 'undefined' && localStorage.getItem('theme')

		return (
			storedTheme || (window.matchMedia('(prefers-color-scheme: light)').matches ? 'dark' : 'light')
		)
	}

	function setTheme(newTheme) {
		const html = document.documentElement
		const isDark = newTheme === 'dark'

		html.classList.toggle('dark', isDark)
		html.classList.toggle('light', !isDark)

		localStorage.setItem('theme', newTheme)
	}

	// set initial theme
	setTheme(getTheme())
	document.addEventListener('astro:after-swap', () => setTheme(getTheme()))

	document.addEventListener('theme-change', (e) => {
		setTheme(e.detail.theme)
	})
</script><script>
	if (!('animations' in localStorage)) {
		localStorage.setItem('animations', 'true')
	} else {
		localStorage.setItem('animations', 'false')
	}
</script><link rel="stylesheet" href="/_astro/_slug_.zXFjmf5d.css"></head> <body class="bg-white text-stone-950 dark:bg-[#0a0910] dark:text-white" data-astro-cid-37fxchfa> <main class="px-5 sm:mx-auto sm:max-w-2xl sm:px-8 lg:px-0 antialiased md:max-w-6xl grid gap-12 mt-4 overflow-hidden md:overflow-visible" data-astro-cid-37fxchfa> <header class="relative flex items-center h-12 font-semibold"> <a class="text-lg mr-auto" href="/">Home</a> <div id="astro-header-drawer" class="shadow rounded-l-lg md:bg-transparent dark:md:bg-transparent bg-white dark:bg-[#0a0910] md:shadow-none md:rounded-none md:border-none md:h-auto md:static absolute transition-transform duration-300 ease-in translate-x-96 md:translate-x-0 top-12 -right-5 pl-4 pt-6 pb-4 md:p-0 h-[200px] w-[200px] z-50"> <nav class="flex h-full flex-col justify-between gap-12 text-left md:flex-row md:w-full md:gap-5"> <div class="flex flex-col gap-8 md:flex-row md:border-r-2 border-black pr-4 dark:border-white"> <a href="/tags" class="text-opacity-60 flex items-center gap-1 text-2xl md:text-base" rel="noopener noreferrer ">  <svg xmlns="http://www.w3.org/2000/svg" class="w-8 md:w-6" viewBox="0 0 24 24" stroke-width="1.25" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M7.859 6h-2.834a2.025 2.025 0 0 0 -2.025 2.025v2.834c0 .537 .213 1.052 .593 1.432l6.116 6.116a2.025 2.025 0 0 0 2.864 0l2.834 -2.834a2.025 2.025 0 0 0 0 -2.864l-6.117 -6.116a2.025 2.025 0 0 0 -1.431 -.593z"></path> <path d="M17.573 18.407l2.834 -2.834a2.025 2.025 0 0 0 0 -2.864l-7.117 -7.116"></path> <path d="M6 9h-.01"></path> </svg> Tags
 </a> </div> <div class="flex justify-center items-center md:justify-end gap-4 md:p-0"> <a href="https://github.com/adriangalera" class="text-opacity-60" rel="noopener noreferrer " target="_blank" aria-label="Github">  <span><svg xmlns="http://www.w3.org/2000/svg" class="w-8 md:w-6" viewBox="0 0 24 24" stroke-width="1.3" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5"></path> </svg> </span>  </a><a href="https://www.linkedin.com/in/adriangalera" class="text-opacity-60" rel="noopener noreferrer " target="_blank" aria-label="Twitter">  <span><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-linkedin" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M4 4m0 2a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2z"></path> <path d="M8 11l0 5"></path> <path d="M8 8l0 .01"></path> <path d="M12 16l0 -5"></path> <path d="M16 16v-3a2 2 0 0 0 -4 0"></path> </svg> </span>  </a> </div> </nav> </div> <div class="flex items-center gap-3 md:pl-3" data-astro-transition-persist="navbar"> <div> <site-search id="search" class="ms-auto"> <button data-open-modal disabled class="flex items-center justify-center rounded-md gap-1"> <svg aria-label="search" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"> <path stroke="none" d="M0 0h24v24H0z"></path> <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path> </svg> <!-- <span class='md:hidden text-2xl'> Search</span> --> </button> <dialog aria-label="search" class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-white dark:bg-[#0a0910ec] shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md opacity-0"> <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6"> <button data-close-modal class="ms-auto cursor-pointer rounded-full bg-black text-white px-4 py-2 dark:bg-white dark:text-black">Close</button> <div class="search-container dark:text-white"> <div id="pagefind__search"></div> </div> </div> </dialog> </site-search> <script type="module" src="/_astro/Search.astro_astro_type_script_index_0_lang.NYKLwWpr.js"></script>  </div> <script type="module">class r extends HTMLElement{constructor(){super();const e=this.querySelector("button");e&&e.addEventListener("click",t=>{if(t.currentTarget instanceof HTMLButtonElement){let n=t.currentTarget.getAttribute("aria-pressed")==="true",s=new CustomEvent("theme-change",{detail:{theme:n?"light":"dark"}});document.dispatchEvent(s),e.setAttribute("aria-pressed",String(!n))}})}}"customElements"in window&&customElements.define("theme-toggle",r);</script> <theme-toggle class="relative h-6 w-6"> <button id="toggle-theme" class="group"> <span class="absolute left-0 right-0 top-0 opacity-0 group-aria-pressed:opacity-100"> <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-sun-high" width="24" height="24" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M14.828 14.828a4 4 0 1 0 -5.656 -5.656a4 4 0 0 0 5.656 5.656z"></path> <path d="M6.343 17.657l-1.414 1.414"></path> <path d="M6.343 6.343l-1.414 -1.414"></path> <path d="M17.657 6.343l1.414 -1.414"></path> <path d="M17.657 17.657l1.414 1.414"></path> <path d="M4 12h-2"></path> <path d="M12 4v-2"></path> <path d="M20 12h2"></path> <path d="M12 20v2"></path> </svg> </span> <span class="absolute left-0 right-0 top-0 opacity-0 group-aria-[pressed=false]:opacity-100"> <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-moon" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.25" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path> </svg> </span> </button> </theme-toggle> <script>
	const button = document.getElementById('toggle-theme')

	function setButtonPresssed() {
		const bodyThemeIsDark = document.documentElement.classList.contains('dark')
		button.setAttribute('aria-pressed', String(bodyThemeIsDark))
	}
	setButtonPresssed()
</script> <button id="astro-header-drawer-button" type="button" class="md:ml-6 md:hidden"> <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-menu-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.25" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M4 6l16 0"></path> <path d="M4 12l16 0"></path> <path d="M4 18l16 0"></path> </svg> <span class="sr-only">Show Menu</span> </button> </div> </header> <script type="module">document.addEventListener("click",e=>{const t=document.getElementById("astro-header-drawer"),n=document.getElementById("astro-header-drawer-button");t?.contains(e.target)||n?.contains(e.target)?t?.classList.toggle("translate-x-96"):t?.classList.add("translate-x-96")});</script>  <article class="min-w-full md:py-4 sm:max-w-none md:max-w-none"> <header class="mb-3 flex flex-col justify-center items-center gap-6"> <div class="flex flex-col gap-2"> <div class="flex items-center justify-center gap-x-1"> <p class="text-center text-sm text-opacity-50">
Published <time class="text-sm font-bold text-opacity-60" datetime="2021-02-18T00:00:00.000Z"> Feb 18, 2021 </time> </p> <p class="text-center text-sm text-opacity-50 font-bold">
- 5 min read </p> </div> <h1 class="text-center text-4xl md:text-6xl md:pb-2.5 font-semibold"> Standalone application for Raspberry Pi </h1> </div> <div class="flex flex-wrap justify-center items-center gap-2 gap-y-4 md:gap-5"> <a href="/tags/linux" aria-label="linux"> <span class="bg-indigo-600 font-semibold text-white dark:bg-indigo-900 dark:text-white shadow text-sm w-fit px-2 py-1 md:px-5 md:py-2 rounded-full"> linux </span> </a><a href="/tags/nodejs" aria-label="nodejs"> <span class="bg-indigo-600 font-semibold text-white dark:bg-indigo-900 dark:text-white shadow text-sm w-fit px-2 py-1 md:px-5 md:py-2 rounded-full"> nodejs </span> </a><a href="/tags/raspberry-pi" aria-label="raspberry-pi"> <span class="bg-indigo-600 font-semibold text-white dark:bg-indigo-900 dark:text-white shadow text-sm w-fit px-2 py-1 md:px-5 md:py-2 rounded-full"> raspberry-pi </span> </a><a href="/tags/devops" aria-label="devops"> <span class="bg-indigo-600 font-semibold text-white dark:bg-indigo-900 dark:text-white shadow text-sm w-fit px-2 py-1 md:px-5 md:py-2 rounded-full"> devops </span> </a><a href="/tags/docker" aria-label="docker"> <span class="bg-indigo-600 font-semibold text-white dark:bg-indigo-900 dark:text-white shadow text-sm w-fit px-2 py-1 md:px-5 md:py-2 rounded-full"> docker </span> </a> </div> </header> <img src="/_astro/featured-image.QCGhLc11_29oTYb.jpg" loading="eager" alt="img of Standalone application for Raspberry Pi" width="1000" height="500" decoding="async" class="rounded-md w-full max-h-[300px]  md:max-h-[500px] my-8 object-cover"> <hr> <div>  <div class="grid grid-cols-1 md:grid-cols-[20%_auto] gap-10 mt-8"> <!-- aside  --> <aside class="md:flex flex-col gap-8 hidden"> <div class="flex flex-col gap-2"> <span class="mb-1 font-bold text-2xl">Share</span> <ul class="flex gap-3 text-black dark:text-white"> <li> <a href="https://twitter.com/intent/tweet?text=Share this post https://www.agalera.eu/standalone-app-raspberry-pi/" aria-label="Share on Twitter"><!--?xml version="1.0" ?--><svg height="32px" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;" version="1.1" viewBox="0 0 512 512" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g><path d="M448,512l-384,0c-35.328,0 -64,-28.672 -64,-64l0,-384c0,-35.328 28.672,-64 64,-64l384,0c35.328,0 64,28.672 64,64l0,384c0,35.328 -28.672,64 -64,64Z" id="Dark_Blue" style="fill:#1da1f2;fill-rule:nonzero;"></path><path d="M196.608,386.048c120.704,0 186.752,-100.096 186.752,-186.752c0,-2.816 0,-5.632 -0.128,-8.448c12.8,-9.216 23.936,-20.864 32.768,-34.048c-11.776,5.248 -24.448,8.704 -37.76,10.368c13.568,-8.064 23.936,-20.992 28.928,-36.352c-12.672,7.552 -26.752,12.928 -41.728,15.872c-12.032,-12.8 -29.056,-20.736 -47.872,-20.736c-36.224,0 -65.664,29.44 -65.664,65.664c0,5.12 0.64,10.112 1.664,14.976c-54.528,-2.688 -102.912,-28.928 -135.296,-68.608c-5.632,9.728 -8.832,20.992 -8.832,33.024c0,22.784 11.648,42.88 29.184,54.656c-10.752,-0.384 -20.864,-3.328 -29.696,-8.192l0,0.896c0,31.744 22.656,58.368 52.608,64.384c-5.504,1.536 -11.264,2.304 -17.28,2.304c-4.224,0 -8.32,-0.384 -12.288,-1.152c8.32,26.112 32.64,45.056 61.312,45.568c-22.528,17.664 -50.816,28.16 -81.536,28.16c-5.248,0 -10.496,-0.256 -15.616,-0.896c28.928,18.432 63.488,29.312 100.48,29.312" id="Logo__x2014__FIXED" style="fill:#fff;fill-rule:nonzero;"></path></g></svg></a> </li> <li> <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://www.agalera.eu/standalone-app-raspberry-pi/" aria-label="Share on LinkedIn"> <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-linkedin" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M4 4m0 2a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2z"></path> <path d="M8 11l0 5"></path> <path d="M8 8l0 .01"></path> <path d="M12 16l0 -5"></path> <path d="M16 16v-3a2 2 0 0 0 -4 0"></path> </svg></a> </li> </ul> </div> <div class="sticky top-24 self-start hidden md:block transition-all duration-200"> <nav class="max-w-xs dark:text-black"> <h2 class="font-bold mb-3 text-2xl dark:text-white">Index</h2> <ul class="[text-wrap:balance] flex flex-col gap-1"> <li class="flex flex-col"> <a href="#requirements" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> Requirements </a>  </li><li class="flex flex-col"> <a href="#solutions" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> Solutions </a> <ul class="ml-3"> <li class="flex flex-col"> <a href="#backend" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> Backend </a>  </li><li class="flex flex-col"> <a href="#frontend" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> Frontend </a>  </li><li class="flex flex-col"> <a href="#cicd" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> CI/CD </a> <ul class="ml-3"> <li class="flex flex-col"> <a href="#docker-image" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> Docker image </a>  </li><li class="flex flex-col"> <a href="#pipeline" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> Pipeline </a>  </li> </ul> </li> </ul> </li><li class="flex flex-col"> <a href="#installation" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> Installation </a>  </li> </ul> </nav> </div> </aside> <!-- post --> <article class="max-w-full w-full"> <div class="prose prose-lg md:prose-xl dark:prose-invert mb-12 min-w-full"> <p>I’m building a small application to give treats to my dog in a remote manner.</p>
<p>I setup a Raspberry Pi with a very basic HTTP server connected to a servo motor that will open or close the deposit where the treats are stored.</p>
<p>In this article I’ll explain all the challenges I found to make this application standalone.</p>
<h2 id="requirements">Requirements</h2>
<ul>
<li>Accessible via web</li>
<li>To have a camera, a button to give treats and a button to play a sound</li>
<li>Easily installable in a Raspberry Pi: no need to install trillions of libraries</li>
<li>Production ready: even though this is a personal project, I want the app to be 100% test covered and to have a full CI/CD cycle</li>
</ul>
<h2 id="solutions">Solutions</h2>
<p>First of all, I did some small investigations and tackle every requirement in a separate way. This way I manage to found scripts that:</p>
<ul>
<li><a href="https://picamera.readthedocs.io/en/release-1.13/recipes2.html#web-streaming">Create a MJPEG stream out of the Raspberry Pi camera</a></li>
<li><a href="https://raspberrypi.stackexchange.com/questions/22708/is-there-some-trick-to-getting-aplay-audio-output-working">Play a sound from the disk</a></li>
<li><a href="https://peppe8o.com/how-to-remote-control-a-servo-motor-sg90-using-raspberry-pi-zero-w-with-python-and-arduino/">Interact with a servo motor</a></li>
</ul>
<h3 id="backend">Backend</h3>
<p>Once the parts are working independently, I made a python project with a very basic HTTP server based on <code>BaseHTTPRequestHandler</code> that receive request to the stream, to interact with the servo and to play a sound.</p>
<p>The interesting thing here was to be able to develop this project without using the Raspberry Pi. This is challenging because the required libraries are hardware specific to the Raspberry. But I manage to mock the camera and the servo libraries by using <code>unittest</code> python package</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#89DDFF;font-style:italic">from</span><span style="color:#BABED8"> unittest</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">mock </span><span style="color:#89DDFF;font-style:italic">import</span><span style="color:#BABED8"> MagicMock</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> patch</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">def</span><span style="color:#82AAFF"> mock_rpi_gpio</span><span style="color:#89DDFF">():</span></span>
<span class="line"><span style="color:#BABED8">    MockRPi </span><span style="color:#89DDFF">=</span><span style="color:#82AAFF"> MagicMock</span><span style="color:#89DDFF">()</span></span>
<span class="line"><span style="color:#BABED8">    modules </span><span style="color:#89DDFF">=</span><span style="color:#89DDFF"> {</span></span>
<span class="line"><span style="color:#89DDFF">        "</span><span style="color:#C3E88D">RPi</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">:</span><span style="color:#BABED8"> MockRPi</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#89DDFF">        "</span><span style="color:#C3E88D">RPi.GPIO</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">:</span><span style="color:#BABED8"> MockRPi</span><span style="color:#89DDFF">.</span><span style="color:#F07178">GPIO</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#89DDFF">    }</span></span>
<span class="line"><span style="color:#BABED8">    patcher </span><span style="color:#89DDFF">=</span><span style="color:#BABED8"> patch</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">dict</span><span style="color:#89DDFF">(</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">sys.modules</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">,</span><span style="color:#82AAFF"> modules</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">    patcher</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">start</span><span style="color:#89DDFF">()</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">def</span><span style="color:#82AAFF"> mock_pi_camera</span><span style="color:#89DDFF">():</span></span>
<span class="line"><span style="color:#BABED8">    picamera </span><span style="color:#89DDFF">=</span><span style="color:#82AAFF"> MagicMock</span><span style="color:#89DDFF">()</span></span>
<span class="line"><span style="color:#BABED8">    modules </span><span style="color:#89DDFF">=</span><span style="color:#89DDFF"> {</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">picamera</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">:</span><span style="color:#BABED8"> picamera</span><span style="color:#89DDFF">,</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">picamera.PiCamera</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">:</span><span style="color:#BABED8"> picamera</span><span style="color:#89DDFF">.</span><span style="color:#F07178">PiCamera</span><span style="color:#89DDFF">}</span></span>
<span class="line"><span style="color:#BABED8">    patcher </span><span style="color:#89DDFF">=</span><span style="color:#BABED8"> patch</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">dict</span><span style="color:#89DDFF">(</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">sys.modules</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">,</span><span style="color:#82AAFF"> modules</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">    patcher</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">start</span><span style="color:#89DDFF">()</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF">mock_rpi_gpio</span><span style="color:#89DDFF">()</span></span>
<span class="line"><span style="color:#82AAFF">mock_pi_camera</span><span style="color:#89DDFF">()</span></span></code></pre>
<p><code>unittest</code> module allows you to define a <code>conftest.py</code> file that will be executed as a configuration step for you unit tests. Having done that, we can have tests that covers all the required functionality, even without installing the required libraries:</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#89DDFF;font-style:italic">from</span><span style="color:#BABED8"> unittest</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">mock </span><span style="color:#89DDFF;font-style:italic">import</span><span style="color:#BABED8"> call</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">import</span><span style="color:#BABED8"> RPi</span><span style="color:#89DDFF">.</span><span style="color:#F07178">GPIO</span><span style="color:#89DDFF;font-style:italic"> as</span><span style="color:#BABED8"> mockGPIO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">from</span><span style="color:#BABED8"> dogfeeder</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">servo </span><span style="color:#89DDFF;font-style:italic">import</span><span style="color:#BABED8"> Servo</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">def</span><span style="color:#82AAFF"> test_initialize_closed_servo</span><span style="color:#89DDFF">():</span></span>
<span class="line"><span style="color:#82AAFF">    Servo</span><span style="color:#89DDFF">()</span></span>
<span class="line"><span style="color:#BABED8">    mockGPIO</span><span style="color:#89DDFF">.</span><span style="color:#F07178">setmode</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">assert_called_once_with</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">mockGPIO</span><span style="color:#89DDFF">.</span><span style="color:#F07178">BCM</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">    mockGPIO</span><span style="color:#89DDFF">.</span><span style="color:#F07178">setup</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">assert_called_once_with</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">Servo</span><span style="color:#89DDFF">.</span><span style="color:#F07178">SERVO_PIN</span><span style="color:#89DDFF">,</span><span style="color:#82AAFF"> mockGPIO</span><span style="color:#89DDFF">.</span><span style="color:#F07178">OUT</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">    mockGPIO</span><span style="color:#89DDFF">.</span><span style="color:#F07178">PWM</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">assert_called_once_with</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">Servo</span><span style="color:#89DDFF">.</span><span style="color:#F07178">SERVO_PIN</span><span style="color:#89DDFF">,</span><span style="color:#F78C6C"> 50</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">    mock_pwm </span><span style="color:#89DDFF">=</span><span style="color:#BABED8"> mockGPIO</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">PWM</span><span style="color:#89DDFF">()</span></span>
<span class="line"><span style="color:#BABED8">    mock_pwm</span><span style="color:#89DDFF">.</span><span style="color:#F07178">start</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">assert_called_once_with</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">Servo</span><span style="color:#89DDFF">.</span><span style="color:#F07178">CLOSED</span><span style="color:#89DDFF">)</span></span></code></pre>
<h3 id="frontend">Frontend</h3>
<p>The implementation of the frontend is super simple. I used React to create 3 components:</p>
<ul>
<li>CallButton: the button that plays an audio file</li>
<li>DispenseTreat: the button that interacts with the servo</li>
<li>WebcamContainer: the img that prints the MJPEG stream out of the Pi Camera.</li>
</ul>
<p>When any button is pressed and API call to backend is done in the background.</p>
<p>Nothing really fancy to see here.</p>
<h3 id="cicd">CI/CD</h3>
<p>When all the logic is done and the tests are passing, I decided that I wanted to go full professional and create a CI/CD pipeline for the project. In order to do that, I used gitlab.com</p>
<p>This has been the most challenging piece of the project. I wanted to create a standalone application so the installation process is keep to the minimum bar. In order to do so, I created a docker image with all the required dependencies to be used by Gitlab pipeline.</p>
<h4 id="docker-image">Docker image</h4>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="dockerfile"><code><span class="line"><span style="color:#F78C6C">FROM</span><span style="color:#BABED8"> balenalib/raspberrypi3-python:3.7-buster</span></span>
<span class="line"><span style="color:#F78C6C">RUN</span><span style="color:#BABED8"> apt update &#x26;&#x26; apt upgrade</span></span>
<span class="line"><span style="color:#F78C6C">RUN</span><span style="color:#BABED8"> apt install build-essential binutils zlib1g-dev</span></span>
<span class="line"><span style="color:#F78C6C">RUN</span><span style="color:#BABED8"> apt install python3-picamera python3-rpi.gpio</span></span>
<span class="line"><span style="color:#F78C6C">RUN</span><span style="color:#BABED8"> pip3 install pyinstaller pytest pytest-cov flake8 requests</span></span></code></pre>
<p>It’s based on <a href="https://github.com/balena-io-library/base-images/tree/master/balena-base-images/device-base/raspberrypi3">balenalib/raspberrypi3-python</a> Docker image, that simulates even the hardware and processor architecture of the Raspberry Pi 3. The docker image also contains all the libraries required to work (picamera, gpio, …) and tools for the CI/CD (pytest, flake8).</p>
<p><code>pyinstaller</code> is installed in order to generate the executable file of the backend</p>
<h4 id="pipeline">Pipeline</h4>
<p>The pipeline contains four stages:</p>
<ul>
<li>test: unit tests of the backend and frontend</li>
<li>release: to generate semantic versioned tags of the project</li>
<li>build: to generate the standalone executable file of the backend and the web site for the frontend. Thanks to <a href="https://threedots.tech/post/automatic-semantic-versioning-in-gitlab-ci/"></a><a href="https://threedots.tech/post/automatic-semantic-versioning-in-gitlab-ci/">https://threedots.tech/post/automatic-semantic-versioning-in-gitlab-ci/</a></li>
<li>publish: I decided to store the generated artifacts within the Gitlab Package Registry</li>
</ul>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="yaml"><code><span class="line"><span style="color:#F07178">stages</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#89DDFF">  -</span><span style="color:#C3E88D"> test</span></span>
<span class="line"><span style="color:#89DDFF">  -</span><span style="color:#C3E88D"> release</span></span>
<span class="line"><span style="color:#89DDFF">  -</span><span style="color:#C3E88D"> build</span></span>
<span class="line"><span style="color:#89DDFF">  -</span><span style="color:#C3E88D"> publish</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178">test-backend</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#F07178">  image</span><span style="color:#89DDFF">:</span><span style="color:#C3E88D"> registry.gitlab.com/adrian.galera/dogfeeder/python-ci</span></span>
<span class="line"><span style="color:#F07178">  stage</span><span style="color:#89DDFF">:</span><span style="color:#C3E88D"> test</span></span>
<span class="line"><span style="color:#F07178">  script</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#89DDFF">    -</span><span style="color:#C3E88D"> cd dogfeeder-backend</span></span>
<span class="line"><span style="color:#89DDFF">    -</span><span style="color:#C3E88D"> pytest --cov --cov-fail-under=100</span></span>
<span class="line"><span style="color:#F07178">  only</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#89DDFF">    -</span><span style="color:#C3E88D"> master</span></span>
<span class="line"><span style="color:#89DDFF">    -</span><span style="color:#C3E88D"> branches</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178">test-frontend</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#F07178">  image</span><span style="color:#89DDFF">:</span><span style="color:#C3E88D"> node:12.13-alpine</span></span>
<span class="line"><span style="color:#F07178">  stage</span><span style="color:#89DDFF">:</span><span style="color:#C3E88D"> test</span></span>
<span class="line"><span style="color:#F07178">  script</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#89DDFF">    -</span><span style="color:#C3E88D"> cd dogfeeder-web</span></span>
<span class="line"><span style="color:#89DDFF">    -</span><span style="color:#C3E88D"> npm ci --cache .npm --prefer-offline</span></span>
<span class="line"><span style="color:#89DDFF">    -</span><span style="color:#C3E88D"> npm test</span></span>
<span class="line"><span style="color:#F07178">  cache</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#F07178">    key</span><span style="color:#89DDFF">:</span><span style="color:#89DDFF"> '</span><span style="color:#C3E88D">node-modules</span><span style="color:#89DDFF">'</span></span>
<span class="line"><span style="color:#F07178">    paths</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#89DDFF">      -</span><span style="color:#C3E88D"> .npm/</span></span>
<span class="line"><span style="color:#F07178">  only</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#89DDFF">    -</span><span style="color:#C3E88D"> master</span></span>
<span class="line"><span style="color:#89DDFF">    -</span><span style="color:#C3E88D"> branches</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178">release</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#F07178">  image</span><span style="color:#89DDFF">:</span><span style="color:#C3E88D"> python:3.7-stretch</span></span>
<span class="line"><span style="color:#F07178">  stage</span><span style="color:#89DDFF">:</span><span style="color:#C3E88D"> release</span></span>
<span class="line"><span style="color:#F07178">  before_script</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#676E95;font-style:italic">    # Allow gitlab runner push code to gitlab.com</span></span>
<span class="line"><span style="color:#676E95;font-style:italic">    # see: https://threedots.tech/post/automatic-semantic-versioning-in-gitlab-ci/</span></span>
<span class="line"><span style="color:#89DDFF">    -</span><span style="color:#C3E88D"> mkdir -p ~/.ssh &#x26;&#x26; chmod 700 ~/.ssh</span></span>
<span class="line"><span style="color:#89DDFF">    -</span><span style="color:#C3E88D"> ssh-keyscan gitlab.com >> ~/.ssh/known_hosts &#x26;&#x26; chmod 644 ~/.ssh/known_hosts</span></span>
<span class="line"><span style="color:#89DDFF">    -</span><span style="color:#C3E88D"> eval $(ssh-agent -s)</span></span>
<span class="line"><span style="color:#89DDFF">    -</span><span style="color:#C3E88D"> ssh-add &#x3C;(echo "$SSH_PRIVATE_KEY")</span></span>
<span class="line"><span style="color:#89DDFF">    -</span><span style="color:#C3E88D"> pip install semver</span></span>
<span class="line"><span style="color:#F07178">  script</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#89DDFF">    -</span><span style="color:#C3E88D"> python3 gen-semver</span></span>
<span class="line"><span style="color:#F07178">  only</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#89DDFF">    -</span><span style="color:#C3E88D"> master</span></span>
<span class="line"><span style="color:#F07178">  when</span><span style="color:#89DDFF">:</span><span style="color:#C3E88D"> manual</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178">build-backend</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#F07178">  image</span><span style="color:#89DDFF">:</span><span style="color:#C3E88D"> registry.gitlab.com/adrian.galera/dogfeeder/python-ci</span></span>
<span class="line"><span style="color:#F07178">  stage</span><span style="color:#89DDFF">:</span><span style="color:#C3E88D"> build</span></span>
<span class="line"><span style="color:#F07178">  script</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#89DDFF">    -</span><span style="color:#C3E88D"> cd dogfeeder-backend</span></span>
<span class="line"><span style="color:#89DDFF">    -</span><span style="color:#C3E88D"> pyinstaller dogfeeder/main.py -F --name dogfeeder-server</span></span>
<span class="line"><span style="color:#F07178">  only</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#89DDFF">    -</span><span style="color:#C3E88D"> tags</span></span>
<span class="line"><span style="color:#F07178">  artifacts</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#F07178">    paths</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#89DDFF">      -</span><span style="color:#89DDFF"> '</span><span style="color:#C3E88D">dogfeeder-backend/dist/dogfeeder-server</span><span style="color:#89DDFF">'</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178">build-frontend</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#F07178">  image</span><span style="color:#89DDFF">:</span><span style="color:#C3E88D"> node:12.13-alpine</span></span>
<span class="line"><span style="color:#F07178">  stage</span><span style="color:#89DDFF">:</span><span style="color:#C3E88D"> build</span></span>
<span class="line"><span style="color:#F07178">  script</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#89DDFF">    -</span><span style="color:#C3E88D"> cd dogfeeder-web</span></span>
<span class="line"><span style="color:#89DDFF">    -</span><span style="color:#C3E88D"> npm ci --cache .npm --prefer-offline</span></span>
<span class="line"><span style="color:#89DDFF">    -</span><span style="color:#C3E88D"> npm run build</span></span>
<span class="line"><span style="color:#89DDFF">    -</span><span style="color:#C3E88D"> npm run zip</span></span>
<span class="line"><span style="color:#F07178">  cache</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#F07178">    key</span><span style="color:#89DDFF">:</span><span style="color:#89DDFF"> '</span><span style="color:#C3E88D">node-modules</span><span style="color:#89DDFF">'</span></span>
<span class="line"><span style="color:#F07178">    paths</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#89DDFF">      -</span><span style="color:#C3E88D"> .npm/</span></span>
<span class="line"><span style="color:#F07178">  artifacts</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#F07178">    paths</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#89DDFF">      -</span><span style="color:#89DDFF"> '</span><span style="color:#C3E88D">dogfeeder-web/dogfeeder-web_.zip</span><span style="color:#89DDFF">'</span></span>
<span class="line"><span style="color:#F07178">  only</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#89DDFF">    -</span><span style="color:#C3E88D"> tags</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F07178">publish</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#F07178">  image</span><span style="color:#89DDFF">:</span><span style="color:#C3E88D"> curlimages/curl:latest</span></span>
<span class="line"><span style="color:#F07178">  stage</span><span style="color:#89DDFF">:</span><span style="color:#C3E88D"> publish</span></span>
<span class="line"><span style="color:#F07178">  script</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#89DDFF">    -</span><span style="color:#C3E88D"> VERSION=${CI_COMMIT_REF_NAME}</span></span>
<span class="line"><span style="color:#89DDFF">    -</span><span style="color:#89DDFF"> '</span><span style="color:#C3E88D">curl --header "JOB-TOKEN: $CI_JOB_TOKEN" --upload-file dogfeeder-backend/dist/dogfeeder-server "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/dogfeeder/${VERSION}/dogfeeder-server"</span><span style="color:#89DDFF">'</span></span>
<span class="line"><span style="color:#89DDFF">    -</span><span style="color:#89DDFF"> '</span><span style="color:#C3E88D">curl --header "JOB-TOKEN: $CI_JOB_TOKEN" --upload-file dogfeeder-web/dogfeeder-web_.zip "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/dogfeeder/${VERSION}/dogfeeder-web.zip"</span><span style="color:#89DDFF">'</span></span>
<span class="line"><span style="color:#F07178">  only</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#89DDFF">    -</span><span style="color:#C3E88D"> tags</span></span></code></pre>
<h2 id="installation">Installation</h2>
<p>Now that the packages are stored in Gitlab, the installation is super simple. I created a script that downloads the artifacts from Gitlab and unzip the web into a running nginx and replace the executable file that will be picked up from a <code>supervisorctl</code> process:</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="shell"><code><span class="line"><span style="color:#BABED8">VERSION</span><span style="color:#89DDFF">=</span><span style="color:#BABED8;font-style:italic">$1</span></span>
<span class="line"><span style="color:#BABED8">TOKEN</span><span style="color:#89DDFF">=${</span><span style="color:#BABED8">GITLAB_ACCESS_TOKEN</span><span style="color:#89DDFF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">if</span><span style="color:#89DDFF"> [</span><span style="color:#89DDFF"> -z</span><span style="color:#89DDFF"> "</span><span style="color:#BABED8;font-style:italic">$1</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF"> ];</span><span style="color:#89DDFF;font-style:italic"> then</span></span>
<span class="line"><span style="color:#82AAFF">    echo</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">You need to provide PACKAGE_VERSION as argument: sudo ./install-dogfeeder.sh &#x3C;PACKAGE_VERSION></span><span style="color:#89DDFF">"</span></span>
<span class="line"><span style="color:#82AAFF">    exit</span><span style="color:#F78C6C"> 1</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">if</span><span style="color:#89DDFF"> [</span><span style="color:#89DDFF"> -z</span><span style="color:#89DDFF"> "</span><span style="color:#BABED8">$TOKEN</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF"> ];</span><span style="color:#89DDFF;font-style:italic"> then</span></span>
<span class="line"><span style="color:#82AAFF">    echo</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">You need to set GITLAB_ACCESS_TOKEN environment variable</span><span style="color:#89DDFF">"</span></span>
<span class="line"><span style="color:#82AAFF">    exit</span><span style="color:#F78C6C"> 1</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">fi</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B">wget</span><span style="color:#C3E88D"> --header</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">PRIVATE-TOKEN: </span><span style="color:#89DDFF">${</span><span style="color:#BABED8">TOKEN</span><span style="color:#89DDFF">}"</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">https://gitlab.com/api/v4/projects/24187261/packages/generic/dogfeeder/</span><span style="color:#89DDFF">${</span><span style="color:#BABED8">VERSION</span><span style="color:#89DDFF">}</span><span style="color:#C3E88D">/dogfeeder-server</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D"> -O</span><span style="color:#C3E88D"> /tmp/dogfeeder-server-</span><span style="color:#89DDFF">${</span><span style="color:#BABED8">VERSION</span><span style="color:#89DDFF">}</span></span>
<span class="line"><span style="color:#FFCB6B">wget</span><span style="color:#C3E88D"> --header</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">PRIVATE-TOKEN: </span><span style="color:#89DDFF">${</span><span style="color:#BABED8">TOKEN</span><span style="color:#89DDFF">}"</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">https://gitlab.com/api/v4/projects/24187261/packages/generic/dogfeeder/</span><span style="color:#89DDFF">${</span><span style="color:#BABED8">VERSION</span><span style="color:#89DDFF">}</span><span style="color:#C3E88D">/dogfeeder-web.zip</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D"> -O</span><span style="color:#C3E88D"> /tmp/dogfeeder-web-</span><span style="color:#89DDFF">${</span><span style="color:#BABED8">VERSION</span><span style="color:#89DDFF">}</span><span style="color:#C3E88D">.zip</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B">unzip</span><span style="color:#C3E88D"> -o</span><span style="color:#C3E88D"> /tmp/dogfeeder-web-</span><span style="color:#89DDFF">${</span><span style="color:#BABED8">VERSION</span><span style="color:#89DDFF">}</span><span style="color:#C3E88D">.zip</span><span style="color:#C3E88D"> -d</span><span style="color:#C3E88D"> /var/www/html/.</span></span>
<span class="line"><span style="color:#676E95;font-style:italic"># Kill the process and supervisorctl will start it again:</span></span>
<span class="line"><span style="color:#FFCB6B">ps</span><span style="color:#C3E88D"> -eaf</span><span style="color:#89DDFF"> |</span><span style="color:#FFCB6B"> grep</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">dogfeeder-server</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF"> |</span><span style="color:#FFCB6B"> grep</span><span style="color:#C3E88D"> -v</span><span style="color:#C3E88D"> grep</span><span style="color:#89DDFF"> |</span><span style="color:#FFCB6B"> awk</span><span style="color:#89DDFF"> '</span><span style="color:#C3E88D">{ print $2 }</span><span style="color:#89DDFF">'</span><span style="color:#89DDFF"> |</span><span style="color:#FFCB6B"> xargs</span><span style="color:#C3E88D"> kill</span><span style="color:#C3E88D"> -9</span><span style="color:#89DDFF"> &#x26;&#x26;</span><span style="color:#FFCB6B"> cp</span><span style="color:#C3E88D"> /tmp/dogfeeder-server-</span><span style="color:#89DDFF">${</span><span style="color:#BABED8">VERSION</span><span style="color:#89DDFF">}</span><span style="color:#C3E88D"> /home/pi/.local/bin/dogfeeder-server</span></span>
<span class="line"><span style="color:#FFCB6B">chmod</span><span style="color:#C3E88D"> +x</span><span style="color:#C3E88D"> /home/pi/.local/bin/dogfeeder-server</span></span></code></pre> </div> </article> </div>  </div> </article>  <footer class="flex justify-center items-center w-full px-16 h-28 border-t-2"> 2025 Adrian Galera
</footer> </main>    </body> </html> <script type="module">const t=()=>{function r(o,a){o.forEach(s=>{const e=document.querySelector(`aside a[href="#${s.target.id}"]`);s.isIntersecting?(e?.classList.remove("bg-slate-200","dark:bg-slate-800"),e?.classList.add("bg-indigo-600","dark:bg-indigo-700","text-white","font-bold","transition-colors","duration-200")):(e?.classList.add("bg-slate-200","dark:bg-slate-800"),e?.classList.remove("bg-indigo-600","dark:bg-indigo-700","text-white","font-bold","transition-colors","duration-200"))})}const i=document.querySelectorAll("div.prose h1, div.prose h2, div.prose h3, div.prose h4, div.prose h5, div.prose h6"),n={root:null,rootMargin:" 15% 0px 0% 0px ",threshold:1},d=new IntersectionObserver(r,n);i.forEach(o=>{d.observe(o)})};t();document.addEventListener("astro:after-swap",t);</script>