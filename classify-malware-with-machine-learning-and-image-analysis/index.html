<!DOCTYPE html><html lang="en" class="scroll-smooth" data-astro-cid-37fxchfa> <head><!-- ViewTransitions  --><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><script type="module" src="/_astro/ClientRouter.astro_astro_type_script_index_0_lang.B3vRBseb.js"></script> <!-- Global Metadata --> <meta charset="utf-8"> <meta name="viewport" content="width=device-width,initial-scale=1"> <link rel="icon" type="image/svg+xml" href="/favicon.svg"> <meta name="generator" content="Astro v5.14.1"> <!-- Canonical URL --> <link rel="canonical" href="https://www.agalera.eu/classify-malware-with-machine-learning-and-image-analysis/"> <!-- SEO --> <meta name="title" content="Classify malware with machine learning and image analysis • agalera.eu"> <meta name="description" content="Turn malware into images and detect threats with Convolutional Neural Networks."> <meta name="author" content="Adrian Galera"> <!-- Open Graph / Facebook --> <meta property="og:type" content="article"> <meta property="og:url" content="https://www.agalera.eu/classify-malware-with-machine-learning-and-image-analysis/"> <meta property="og:title" content="Classify malware with machine learning and image analysis"> <meta property="og:description" content="Turn malware into images and detect threats with Convolutional Neural Networks."> <meta property="og:image" content="https://www.agalera.eu/_astro/pexels-lucasandrade-14066351.ZYpXVZ_1.jpg">  <meta property="article:author" content="Adrian Galera"> <meta property="article:published_time" content="2025-10-08T00:00:00.000Z">  <!-- Twitter --> <meta property="twitter:card" content="summary_large_image"> <meta property="twitter:url" content="https://www.agalera.eu/classify-malware-with-machine-learning-and-image-analysis/"> <meta property="twitter:title" content="Classify malware with machine learning and image analysis"> <meta property="twitter:description" content="Turn malware into images and detect threats with Convolutional Neural Networks."> <meta property="twitter:image" content="https://www.agalera.eu/_astro/pexels-lucasandrade-14066351.ZYpXVZ_1.jpg"> <!-- RSS auto-discovery --> <link rel="alternate" type="application/rss+xml" title="agalera.eu" href="/rss.xml"> <!-- Google tag (gtag.js) --> <script async src="https://www.googletagmanager.com/gtag/js?id=G-S8VGYBN25C"></script> <script type="module">const n=window.location.hostname;n.includes("agalera.eu")||(console.log("Disabling analytics..."),window["ga-disable-G-S8VGYBN25C"]=!0);window.dataLayer=window.dataLayer||[];function a(){dataLayer.push(arguments)}a("js",new Date);a("config","G-S8VGYBN25C");</script> <!-- Primary Meta Tags --> <title>Classify malware with machine learning and image analysis • agalera.eu</title><script>
	function getTheme() {
		const storedTheme = typeof localStorage !== 'undefined' && localStorage.getItem('theme')

		return (
			storedTheme || (window.matchMedia('(prefers-color-scheme: light)').matches ? 'dark' : 'light')
		)
	}

	function setTheme(newTheme) {
		const html = document.documentElement
		const isDark = newTheme === 'dark'

		html.classList.toggle('dark', isDark)
		html.classList.toggle('light', !isDark)

		localStorage.setItem('theme', newTheme)
	}

	// set initial theme
	setTheme(getTheme())
	document.addEventListener('astro:after-swap', () => setTheme(getTheme()))

	document.addEventListener('theme-change', (e) => {
		setTheme(e.detail.theme)
	})
</script><script>
	if (!('animations' in localStorage)) {
		localStorage.setItem('animations', 'true')
	} else {
		localStorage.setItem('animations', 'false')
	}
</script><link rel="stylesheet" href="/_astro/_slug_.CMnNCk3f.css"></head> <body class="bg-white text-stone-950 dark:bg-[#0a0910] dark:text-white" data-astro-cid-37fxchfa> <main class="px-5 sm:mx-auto sm:max-w-2xl sm:px-8 lg:px-0 antialiased md:max-w-6xl grid gap-12 mt-4 overflow-hidden md:overflow-visible" data-astro-cid-37fxchfa> <header class="relative flex items-center h-12 font-semibold"> <a class="text-lg mr-auto" href="/">Home</a> <div id="astro-header-drawer" class="shadow rounded-l-lg md:bg-transparent dark:md:bg-transparent bg-white dark:bg-[#0a0910] md:shadow-none md:rounded-none md:border-none md:h-auto md:static absolute transition-transform duration-300 ease-in translate-x-96 md:translate-x-0 top-12 -right-5 pl-4 pt-6 pb-4 md:p-0 h-[200px] w-[200px] z-50"> <nav class="flex h-full flex-col justify-between gap-12 text-left md:flex-row md:w-full md:gap-5"> <div class="flex flex-col gap-8 md:flex-row md:border-r-2 border-black pr-4 dark:border-white"> <a href="/tags" class="text-opacity-60 flex items-center gap-1 text-2xl md:text-base" rel="noopener noreferrer ">  <svg xmlns="http://www.w3.org/2000/svg" class="w-8 md:w-6" viewBox="0 0 24 24" stroke-width="1.25" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M7.859 6h-2.834a2.025 2.025 0 0 0 -2.025 2.025v2.834c0 .537 .213 1.052 .593 1.432l6.116 6.116a2.025 2.025 0 0 0 2.864 0l2.834 -2.834a2.025 2.025 0 0 0 0 -2.864l-6.117 -6.116a2.025 2.025 0 0 0 -1.431 -.593z"></path> <path d="M17.573 18.407l2.834 -2.834a2.025 2.025 0 0 0 0 -2.864l-7.117 -7.116"></path> <path d="M6 9h-.01"></path> </svg> Tags
 </a> </div> <div class="flex justify-center items-center md:justify-end gap-4 md:p-0"> <a href="https://github.com/adriangalera" class="text-opacity-60" rel="noopener noreferrer " target="_blank" aria-label="Github">  <span><svg xmlns="http://www.w3.org/2000/svg" class="w-8 md:w-6" viewBox="0 0 24 24" stroke-width="1.3" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5"></path> </svg> </span>  </a><a href="https://www.linkedin.com/in/adriangalera" class="text-opacity-60" rel="noopener noreferrer " target="_blank" aria-label="Twitter">  <span><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-linkedin" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M4 4m0 2a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2z"></path> <path d="M8 11l0 5"></path> <path d="M8 8l0 .01"></path> <path d="M12 16l0 -5"></path> <path d="M16 16v-3a2 2 0 0 0 -4 0"></path> </svg> </span>  </a> </div> </nav> </div> <div class="flex items-center gap-3 md:pl-3" data-astro-transition-persist="navbar"> <div> <site-search id="search" class="ms-auto"> <button data-open-modal disabled class="flex items-center justify-center rounded-md gap-1"> <svg aria-label="search" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"> <path stroke="none" d="M0 0h24v24H0z"></path> <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path> </svg> <!-- <span class='md:hidden text-2xl'> Search</span> --> </button> <dialog aria-label="search" class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-white dark:bg-[#0a0910ec] shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md opacity-0"> <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6"> <button data-close-modal class="ms-auto cursor-pointer rounded-full bg-black text-white px-4 py-2 dark:bg-white dark:text-black">Close</button> <div class="search-container dark:text-white"> <div id="pagefind__search"></div> </div> </div> </dialog> </site-search> <script type="module" src="/_astro/Search.astro_astro_type_script_index_0_lang.xPnMudr4.js"></script>  </div> <script type="module">class r extends HTMLElement{constructor(){super();const e=this.querySelector("button");e&&e.addEventListener("click",t=>{if(t.currentTarget instanceof HTMLButtonElement){let n=t.currentTarget.getAttribute("aria-pressed")==="true",s=new CustomEvent("theme-change",{detail:{theme:n?"light":"dark"}});document.dispatchEvent(s),e.setAttribute("aria-pressed",String(!n))}})}}"customElements"in window&&customElements.define("theme-toggle",r);</script> <theme-toggle class="relative h-6 w-6"> <button id="toggle-theme" class="group"> <span class="absolute left-0 right-0 top-0 opacity-0 group-aria-pressed:opacity-100"> <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-sun-high" width="24" height="24" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M14.828 14.828a4 4 0 1 0 -5.656 -5.656a4 4 0 0 0 5.656 5.656z"></path> <path d="M6.343 17.657l-1.414 1.414"></path> <path d="M6.343 6.343l-1.414 -1.414"></path> <path d="M17.657 6.343l1.414 -1.414"></path> <path d="M17.657 17.657l1.414 1.414"></path> <path d="M4 12h-2"></path> <path d="M12 4v-2"></path> <path d="M20 12h2"></path> <path d="M12 20v2"></path> </svg> </span> <span class="absolute left-0 right-0 top-0 opacity-0 group-aria-[pressed=false]:opacity-100"> <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-moon" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.25" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path> </svg> </span> </button> </theme-toggle> <script>
	const button = document.getElementById('toggle-theme')

	function setButtonPresssed() {
		const bodyThemeIsDark = document.documentElement.classList.contains('dark')
		button.setAttribute('aria-pressed', String(bodyThemeIsDark))
	}
	setButtonPresssed()
</script> <button id="astro-header-drawer-button" type="button" class="md:ml-6 md:hidden"> <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-menu-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.25" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M4 6l16 0"></path> <path d="M4 12l16 0"></path> <path d="M4 18l16 0"></path> </svg> <span class="sr-only">Show Menu</span> </button> </div> </header> <script type="module">document.addEventListener("click",e=>{const t=document.getElementById("astro-header-drawer"),n=document.getElementById("astro-header-drawer-button");t?.contains(e.target)||n?.contains(e.target)?t?.classList.toggle("translate-x-96"):t?.classList.add("translate-x-96")});</script>  <article class="min-w-full md:py-4 sm:max-w-none md:max-w-none"> <header class="mb-3 flex flex-col justify-center items-center gap-6"> <div class="flex flex-col gap-2"> <div class="flex items-center justify-center gap-x-1"> <p class="text-center text-sm text-opacity-50">
Published <time class="text-sm font-bold text-opacity-60" datetime="2025-10-08T00:00:00.000Z"> Oct 8, 2025 </time> </p> <p class="text-center text-sm text-opacity-50 font-bold">
- 8 min read </p> </div> <h1 class="text-center text-4xl md:text-6xl md:pb-2.5 font-semibold"> Classify malware with machine learning and image analysis </h1> </div> <div class="flex flex-wrap justify-center items-center gap-2 gap-y-4 md:gap-5"> <a href="/tags/infosec" aria-label="infosec"> <span class="bg-indigo-600 font-semibold text-white dark:bg-indigo-900 dark:text-white shadow text-sm w-fit px-2 py-1 md:px-5 md:py-2 rounded-full"> infosec </span> </a><a href="/tags/ml" aria-label="ml"> <span class="bg-indigo-600 font-semibold text-white dark:bg-indigo-900 dark:text-white shadow text-sm w-fit px-2 py-1 md:px-5 md:py-2 rounded-full"> ml </span> </a><a href="/tags/malware" aria-label="malware"> <span class="bg-indigo-600 font-semibold text-white dark:bg-indigo-900 dark:text-white shadow text-sm w-fit px-2 py-1 md:px-5 md:py-2 rounded-full"> malware </span> </a><a href="/tags/neural networks" aria-label="neural networks"> <span class="bg-indigo-600 font-semibold text-white dark:bg-indigo-900 dark:text-white shadow text-sm w-fit px-2 py-1 md:px-5 md:py-2 rounded-full"> neural networks </span> </a> </div> </header> <img src="/_astro/pexels-lucasandrade-14066351.ZYpXVZ_1_2czBfF.jpg" loading="eager" alt="img of Classify malware with machine learning and image analysis" decoding="async" fetchpriority="auto" width="1000" height="500" class="rounded-md w-full max-h-[300px]  md:max-h-[500px] my-8 object-cover"> <hr> <div>  <div class="grid grid-cols-1 md:grid-cols-[20%_auto] gap-10 mt-8"> <!-- aside  --> <aside class="md:flex flex-col gap-8 hidden"> <div class="flex flex-col gap-2"> <span class="mb-1 font-bold text-2xl">Share</span> <ul class="flex gap-3 text-black dark:text-white"> <li> <a href="https://twitter.com/intent/tweet?text=Share this post https://www.agalera.eu/classify-malware-with-machine-learning-and-image-analysis/" aria-label="Share on Twitter"><!--?xml version="1.0" ?--><svg height="32px" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;" version="1.1" viewBox="0 0 512 512" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g><path d="M448,512l-384,0c-35.328,0 -64,-28.672 -64,-64l0,-384c0,-35.328 28.672,-64 64,-64l384,0c35.328,0 64,28.672 64,64l0,384c0,35.328 -28.672,64 -64,64Z" id="Dark_Blue" style="fill:#1da1f2;fill-rule:nonzero;"></path><path d="M196.608,386.048c120.704,0 186.752,-100.096 186.752,-186.752c0,-2.816 0,-5.632 -0.128,-8.448c12.8,-9.216 23.936,-20.864 32.768,-34.048c-11.776,5.248 -24.448,8.704 -37.76,10.368c13.568,-8.064 23.936,-20.992 28.928,-36.352c-12.672,7.552 -26.752,12.928 -41.728,15.872c-12.032,-12.8 -29.056,-20.736 -47.872,-20.736c-36.224,0 -65.664,29.44 -65.664,65.664c0,5.12 0.64,10.112 1.664,14.976c-54.528,-2.688 -102.912,-28.928 -135.296,-68.608c-5.632,9.728 -8.832,20.992 -8.832,33.024c0,22.784 11.648,42.88 29.184,54.656c-10.752,-0.384 -20.864,-3.328 -29.696,-8.192l0,0.896c0,31.744 22.656,58.368 52.608,64.384c-5.504,1.536 -11.264,2.304 -17.28,2.304c-4.224,0 -8.32,-0.384 -12.288,-1.152c8.32,26.112 32.64,45.056 61.312,45.568c-22.528,17.664 -50.816,28.16 -81.536,28.16c-5.248,0 -10.496,-0.256 -15.616,-0.896c28.928,18.432 63.488,29.312 100.48,29.312" id="Logo__x2014__FIXED" style="fill:#fff;fill-rule:nonzero;"></path></g></svg></a> </li> <li> <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://www.agalera.eu/classify-malware-with-machine-learning-and-image-analysis/" aria-label="Share on LinkedIn"> <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-linkedin" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M4 4m0 2a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2z"></path> <path d="M8 11l0 5"></path> <path d="M8 8l0 .01"></path> <path d="M12 16l0 -5"></path> <path d="M16 16v-3a2 2 0 0 0 -4 0"></path> </svg></a> </li> </ul> </div> <div class="sticky top-24 self-start hidden md:block transition-all duration-200"> <nav class="max-w-xs dark:text-black"> <h2 class="font-bold mb-3 text-2xl dark:text-white">Index</h2> <ul class="[text-wrap:balance] flex flex-col gap-1"> <li class="flex flex-col"> <a href="#the-dataset" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> The dataset </a>  </li><li class="flex flex-col"> <a href="#convolutional-neural-networks" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> Convolutional Neural Networks </a>  </li><li class="flex flex-col"> <a href="#preparing-the-dataset" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> Preparing the dataset </a>  </li><li class="flex flex-col"> <a href="#creating-the-cnn" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> Creating the CNN </a>  </li><li class="flex flex-col"> <a href="#training-the-model" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> Training the model </a>  </li><li class="flex flex-col"> <a href="#model-evaluation" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> Model evaluation </a>  </li> </ul> </nav> </div> </aside> <!-- post --> <article class="max-w-full w-full"> <div class="prose prose-lg md:prose-xl dark:prose-invert mb-12 min-w-full"> <p>This post continues with the series of articles related with Hack the box academy module about using AI for information security tasks. This time is about malware analysis using machine learning.</p>
<p>Managing malware is potentially harmful, if the payload gets executed, our own computer will be infected, potentially causing a huge harm.</p>
<p>In this article, a malware classifier will be built based on the proposal of this <a href="https://arxiv.org/pdf/2010.16108">paper</a>. The main idea is the malware payload will be converted into a grey-scale image. The payload binary is grouped by bytes (that goes from 0 to 256 integer value), in the next stage, the bytes are converted into pixels of an image, effectively generating an image that represents exactly the contents of the malware.</p>
<p>Dealing with the image instead of the payload binary is safe, since the image will not be executed.</p>
<p>Surprisingly families of similar malware show a similar image signature. The following example represents two payload of <code>FakeRean</code>malware family. While it’s not the same picture, we can similar patterns.</p>







<table><thead><tr><th><img  loading="lazy" decoding="async" fetchpriority="auto" width="384" height="285" src="/_astro/dataset_2.DMnYyO1D_1xjLSg.webp" ></th><th><img  loading="lazy" decoding="async" fetchpriority="auto" width="384" height="285" src="/_astro/dataset_3.D9hpigAg_ZrhKjc.webp" ></th></tr></thead></table>
<h2 id="the-dataset">The dataset</h2>
<p>The dataset of images can be obtained from <a href="https://www.kaggle.com/api/v1/datasets/download/ikrambenabd/malimg-original">kaggle.</a></p>
<p>It is a zip file with a bunch of malware families and a bunch of image of the payloads. The following code provides an histogram to see the counts of the different malware families in the dataset:</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#676E95;font-style:italic"># Explore the dataset</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">import</span><span style="color:#BABED8"> os</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">import</span><span style="color:#BABED8"> matplotlib</span><span style="color:#89DDFF">.</span><span style="color:#F07178">pyplot</span><span style="color:#89DDFF;font-style:italic"> as</span><span style="color:#BABED8"> plt</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">import</span><span style="color:#BABED8"> seaborn </span><span style="color:#89DDFF;font-style:italic">as</span><span style="color:#BABED8"> sns</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8">DATA_BASE_PATH </span><span style="color:#89DDFF">=</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">./malimg_paper_dataset_imgs/</span><span style="color:#89DDFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic"># compute the class distribution</span></span>
<span class="line"><span style="color:#BABED8">dist </span><span style="color:#89DDFF">=</span><span style="color:#89DDFF"> {}</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">for</span><span style="color:#BABED8"> mlw_class </span><span style="color:#89DDFF;font-style:italic">in</span><span style="color:#BABED8"> os</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">listdir</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">DATA_BASE_PATH</span><span style="color:#89DDFF">):</span></span>
<span class="line"><span style="color:#BABED8">    mlw_dir </span><span style="color:#89DDFF">=</span><span style="color:#BABED8"> os</span><span style="color:#89DDFF">.</span><span style="color:#F07178">path</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">join</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">DATA_BASE_PATH</span><span style="color:#89DDFF">,</span><span style="color:#82AAFF"> mlw_class</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">    dist</span><span style="color:#89DDFF">[</span><span style="color:#BABED8">mlw_class</span><span style="color:#89DDFF">]</span><span style="color:#89DDFF"> =</span><span style="color:#82AAFF"> len</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">os</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">listdir</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">mlw_dir</span><span style="color:#89DDFF">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic"># plot the class distribution</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic"># HTB Color Palette</span></span>
<span class="line"><span style="color:#BABED8">htb_green </span><span style="color:#89DDFF">=</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">#9FEF00</span><span style="color:#89DDFF">"</span></span>
<span class="line"><span style="color:#BABED8">node_black </span><span style="color:#89DDFF">=</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">#141D2B</span><span style="color:#89DDFF">"</span></span>
<span class="line"><span style="color:#BABED8">hacker_grey </span><span style="color:#89DDFF">=</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">#A4B1CD</span><span style="color:#89DDFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic"># data</span></span>
<span class="line"><span style="color:#BABED8">classes </span><span style="color:#89DDFF">=</span><span style="color:#FFCB6B"> list</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">dist</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">keys</span><span style="color:#89DDFF">())</span></span>
<span class="line"><span style="color:#BABED8">frequencies </span><span style="color:#89DDFF">=</span><span style="color:#FFCB6B"> list</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">dist</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">values</span><span style="color:#89DDFF">())</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic"># plot</span></span>
<span class="line"><span style="color:#BABED8">plt</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">figure</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">facecolor</span><span style="color:#89DDFF">=</span><span style="color:#82AAFF">node_black</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">sns</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">barplot</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">y</span><span style="color:#89DDFF">=</span><span style="color:#82AAFF">classes</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> x</span><span style="color:#89DDFF">=</span><span style="color:#82AAFF">frequencies</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> edgecolor</span><span style="color:#89DDFF"> =</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">black</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> orient</span><span style="color:#89DDFF">=</span><span style="color:#89DDFF">'</span><span style="color:#C3E88D">h</span><span style="color:#89DDFF">'</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> color</span><span style="color:#89DDFF">=</span><span style="color:#82AAFF">htb_green</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">plt</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">title</span><span style="color:#89DDFF">(</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">Malware Class Distribution</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> color</span><span style="color:#89DDFF">=</span><span style="color:#82AAFF">htb_green</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">plt</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">xlabel</span><span style="color:#89DDFF">(</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">Malware Class Frequency</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> color</span><span style="color:#89DDFF">=</span><span style="color:#82AAFF">htb_green</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">plt</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">ylabel</span><span style="color:#89DDFF">(</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">Malware Class</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> color</span><span style="color:#89DDFF">=</span><span style="color:#82AAFF">htb_green</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">plt</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">xticks</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">color</span><span style="color:#89DDFF">=</span><span style="color:#82AAFF">hacker_grey</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">plt</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">yticks</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">color</span><span style="color:#89DDFF">=</span><span style="color:#82AAFF">hacker_grey</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">ax </span><span style="color:#89DDFF">=</span><span style="color:#BABED8"> plt</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">gca</span><span style="color:#89DDFF">()</span></span>
<span class="line"><span style="color:#BABED8">ax</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">set_facecolor</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">node_black</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">ax</span><span style="color:#89DDFF">.</span><span style="color:#F07178">spines</span><span style="color:#89DDFF">[</span><span style="color:#89DDFF">'</span><span style="color:#C3E88D">bottom</span><span style="color:#89DDFF">'</span><span style="color:#89DDFF">].</span><span style="color:#82AAFF">set_color</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">hacker_grey</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">ax</span><span style="color:#89DDFF">.</span><span style="color:#F07178">spines</span><span style="color:#89DDFF">[</span><span style="color:#89DDFF">'</span><span style="color:#C3E88D">top</span><span style="color:#89DDFF">'</span><span style="color:#89DDFF">].</span><span style="color:#82AAFF">set_color</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">node_black</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">ax</span><span style="color:#89DDFF">.</span><span style="color:#F07178">spines</span><span style="color:#89DDFF">[</span><span style="color:#89DDFF">'</span><span style="color:#C3E88D">right</span><span style="color:#89DDFF">'</span><span style="color:#89DDFF">].</span><span style="color:#82AAFF">set_color</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">node_black</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">ax</span><span style="color:#89DDFF">.</span><span style="color:#F07178">spines</span><span style="color:#89DDFF">[</span><span style="color:#89DDFF">'</span><span style="color:#C3E88D">left</span><span style="color:#89DDFF">'</span><span style="color:#89DDFF">].</span><span style="color:#82AAFF">set_color</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">hacker_grey</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">plt</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">show</span><span style="color:#89DDFF">()</span></span></code></pre>
<p><img  loading="lazy" decoding="async" fetchpriority="auto" width="1049" height="540" src="/_astro/dataset_4_fixed.B1ZRD3M8_aWyLO.webp" ></p>
<h2 id="convolutional-neural-networks">Convolutional Neural Networks</h2>
<p>This is an image classification task and Convolutional Neural Networks (CNNs) are the perfect tool for this. This type of neural networks provide a hierarchical analysis of the images where the first layers of the network detect simple shapes and following layers detect more complex features of the images.</p>
<p>The term convolutional comes from a mathematical concept. The convolution is an operation where a function is compared with another function and the output is how the first function shape is modified by the second function.</p>
<p>Since each neuron is interested in one particular feature, each network will apply a convolution to reveal how the input image reacts to the feature convolution function. This allow the neural network to extract many different features of the image.</p>
<h2 id="preparing-the-dataset">Preparing the dataset</h2>
<p>Similar to other scenarios, the input data needs to be transformed so that it fits the expectations of the model. In this case, we are dealing with image files inside folders (used as labels).</p>
<p>In the other scenarios, the dataset was loaded in memory and split within the program itself. However, in this case we cannot do that, instead we’ll rely on a library that will split the files dataset for us:</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#89DDFF;font-style:italic">import</span><span style="color:#BABED8"> splitfolders</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8">DATA_BASE_PATH </span><span style="color:#89DDFF">=</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">./malimg_paper_dataset_imgs/</span><span style="color:#89DDFF">"</span></span>
<span class="line"><span style="color:#BABED8">TARGET_BASE_PATH </span><span style="color:#89DDFF">=</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">./newdata/</span><span style="color:#89DDFF">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8">TRAINING_RATIO </span><span style="color:#89DDFF">=</span><span style="color:#F78C6C"> 0.8</span></span>
<span class="line"><span style="color:#BABED8">TEST_RATIO </span><span style="color:#89DDFF">=</span><span style="color:#F78C6C"> 1</span><span style="color:#89DDFF"> -</span><span style="color:#BABED8"> TRAINING_RATIO</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8">splitfolders</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">ratio</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">input</span><span style="color:#89DDFF">=</span><span style="color:#82AAFF">DATA_BASE_PATH</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> output</span><span style="color:#89DDFF">=</span><span style="color:#82AAFF">TARGET_BASE_PATH</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> ratio</span><span style="color:#89DDFF">=(</span><span style="color:#82AAFF">TRAINING_RATIO</span><span style="color:#89DDFF">,</span><span style="color:#F78C6C"> 0</span><span style="color:#89DDFF">,</span><span style="color:#82AAFF"> TEST_RATIO</span><span style="color:#89DDFF">))</span></span></code></pre>
<p>The data will be in the newdata folder and split according to the passed ratio.</p>
<p>Now the data needs to be adapted to be processed via the CNN:</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#89DDFF;font-style:italic">from</span><span style="color:#BABED8"> torchvision </span><span style="color:#89DDFF;font-style:italic">import</span><span style="color:#BABED8"> transforms</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic"># Define preprocessing transforms</span></span>
<span class="line"><span style="color:#BABED8">transform </span><span style="color:#89DDFF">=</span><span style="color:#BABED8"> transforms</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">Compose</span><span style="color:#89DDFF">([</span></span>
<span class="line"><span style="color:#82AAFF">	transforms</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">Resize</span><span style="color:#89DDFF">((</span><span style="color:#F78C6C">75</span><span style="color:#89DDFF">,</span><span style="color:#F78C6C"> 75</span><span style="color:#89DDFF">)),</span></span>
<span class="line"><span style="color:#82AAFF">    transforms</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">ToTensor</span><span style="color:#89DDFF">(),</span></span>
<span class="line"><span style="color:#82AAFF">    transforms</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">Normalize</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">mean</span><span style="color:#89DDFF">=[</span><span style="color:#F78C6C">0.485</span><span style="color:#89DDFF">,</span><span style="color:#F78C6C"> 0.456</span><span style="color:#89DDFF">,</span><span style="color:#F78C6C"> 0.406</span><span style="color:#89DDFF">],</span><span style="color:#BABED8;font-style:italic"> std</span><span style="color:#89DDFF">=[</span><span style="color:#F78C6C">0.229</span><span style="color:#89DDFF">,</span><span style="color:#F78C6C"> 0.224</span><span style="color:#89DDFF">,</span><span style="color:#F78C6C"> 0.225</span><span style="color:#89DDFF">])</span></span>
<span class="line"><span style="color:#89DDFF">])</span></span></code></pre>
<p>First the image is resized to an standard image size of 75x75 pixels. This is a trade-off between image detail (information) and performance (smaller images are easier to process). Also CNN require image of uniform size.</p>
<p>Later the image format is change to tensor. This moves the values from 0 to 255 to 0 to 1 and re-arrange the channels to the format tensorflow expects.</p>
<p>Lastly, the image is normalized by substracting the mean for each channel and dividing it by the standard deviation. These are standard normalization values used for pre-trained models.</p>
<p>After that, tensorflow requires some specific way of defining how the data will be loaded. The following function implements the logic to combine the dataset transformations and the tensorflow loaders:</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#C792EA">def</span><span style="color:#82AAFF"> load_datasets</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">base_path</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> train_batch_size</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> test_batch_size</span><span style="color:#89DDFF">):</span></span>
<span class="line"><span style="color:#676E95;font-style:italic">    # Define preprocessing transforms</span></span>
<span class="line"><span style="color:#BABED8">    transform </span><span style="color:#89DDFF">=</span><span style="color:#BABED8"> transforms</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">Compose</span><span style="color:#89DDFF">([</span></span>
<span class="line"><span style="color:#82AAFF">        transforms</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">Resize</span><span style="color:#89DDFF">((</span><span style="color:#F78C6C">75</span><span style="color:#89DDFF">,</span><span style="color:#F78C6C"> 75</span><span style="color:#89DDFF">)),</span></span>
<span class="line"><span style="color:#82AAFF">        transforms</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">ToTensor</span><span style="color:#89DDFF">(),</span></span>
<span class="line"><span style="color:#82AAFF">        transforms</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">Normalize</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">mean</span><span style="color:#89DDFF">=[</span><span style="color:#F78C6C">0.485</span><span style="color:#89DDFF">,</span><span style="color:#F78C6C"> 0.456</span><span style="color:#89DDFF">,</span><span style="color:#F78C6C"> 0.406</span><span style="color:#89DDFF">],</span><span style="color:#BABED8;font-style:italic"> std</span><span style="color:#89DDFF">=[</span><span style="color:#F78C6C">0.229</span><span style="color:#89DDFF">,</span><span style="color:#F78C6C"> 0.224</span><span style="color:#89DDFF">,</span><span style="color:#F78C6C"> 0.225</span><span style="color:#89DDFF">])</span></span>
<span class="line"><span style="color:#89DDFF">    ])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic">    # Load training and test datasets</span></span>
<span class="line"><span style="color:#BABED8">    train_dataset </span><span style="color:#89DDFF">=</span><span style="color:#82AAFF"> ImageFolder</span><span style="color:#89DDFF">(</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic">        root</span><span style="color:#89DDFF">=</span><span style="color:#82AAFF">os</span><span style="color:#89DDFF">.</span><span style="color:#F07178">path</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">join</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">base_path</span><span style="color:#89DDFF">,</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">train</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">),</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic">        transform</span><span style="color:#89DDFF">=</span><span style="color:#82AAFF">transform</span></span>
<span class="line"><span style="color:#89DDFF">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8">    test_dataset </span><span style="color:#89DDFF">=</span><span style="color:#82AAFF"> ImageFolder</span><span style="color:#89DDFF">(</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic">        root</span><span style="color:#89DDFF">=</span><span style="color:#82AAFF">os</span><span style="color:#89DDFF">.</span><span style="color:#F07178">path</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">join</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">base_path</span><span style="color:#89DDFF">,</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">test</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">),</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic">        transform</span><span style="color:#89DDFF">=</span><span style="color:#82AAFF">transform</span></span>
<span class="line"><span style="color:#89DDFF">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic">    # Create data loaders</span></span>
<span class="line"><span style="color:#BABED8">    train_loader </span><span style="color:#89DDFF">=</span><span style="color:#82AAFF"> DataLoader</span><span style="color:#89DDFF">(</span></span>
<span class="line"><span style="color:#82AAFF">        train_dataset</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic">        batch_size</span><span style="color:#89DDFF">=</span><span style="color:#82AAFF">train_batch_size</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic">        shuffle</span><span style="color:#89DDFF">=True,</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic">        num_workers</span><span style="color:#89DDFF">=</span><span style="color:#F78C6C">2</span></span>
<span class="line"><span style="color:#89DDFF">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8">    test_loader </span><span style="color:#89DDFF">=</span><span style="color:#82AAFF"> DataLoader</span><span style="color:#89DDFF">(</span></span>
<span class="line"><span style="color:#82AAFF">        test_dataset</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic">        batch_size</span><span style="color:#89DDFF">=</span><span style="color:#82AAFF">test_batch_size</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic">        shuffle</span><span style="color:#89DDFF">=False,</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic">        num_workers</span><span style="color:#89DDFF">=</span><span style="color:#F78C6C">2</span></span>
<span class="line"><span style="color:#89DDFF">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8">    n_classes </span><span style="color:#89DDFF">=</span><span style="color:#82AAFF"> len</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">train_dataset</span><span style="color:#89DDFF">.</span><span style="color:#F07178">classes</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">    return</span><span style="color:#BABED8"> train_loader</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> test_loader</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> n_classes</span></span></code></pre>
<h2 id="creating-the-cnn">Creating the CNN</h2>
<p>In order to simplify the things and speed up training time, we’ll be using a pre-trained CNN called ResNet50. The model has 50 layers and 23 milion parameters. The model is really strong in image classification, so it’s a perfect fit for our needs.</p>
<p>To speed up the training process, we’ll rely on the pre-defined weights of the CNN as the baseline for the training. We’ll then pass the training dataset to compute the weights of the CNN through the forward and backward propagation technique.</p>
<p>To simplify things even more, we’ll only compute the weights of the output layer of the CNN. Of course, the length of the output layer needs to be adjusted to the number of classes we have in the dataset.</p>
<p>The following class implements such CNN:</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#89DDFF;font-style:italic">import</span><span style="color:#BABED8"> torch</span><span style="color:#89DDFF">.</span><span style="color:#F07178">nn</span><span style="color:#89DDFF;font-style:italic"> as</span><span style="color:#BABED8"> nn</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">import</span><span style="color:#BABED8"> torchvision</span><span style="color:#89DDFF">.</span><span style="color:#F07178">models</span><span style="color:#89DDFF;font-style:italic"> as</span><span style="color:#BABED8"> models</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic">#The original final layer of ResNet-50 is designed to output 1000 ImageNet classes.</span></span>
<span class="line"><span style="color:#BABED8">HIDDEN_LAYER_SIZE </span><span style="color:#89DDFF">=</span><span style="color:#F78C6C"> 1000</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">class</span><span style="color:#FFCB6B"> MalwareClassifier</span><span style="color:#89DDFF">(</span><span style="color:#FFCB6B">nn</span><span style="color:#89DDFF">.</span><span style="color:#FFCB6B">Module</span><span style="color:#89DDFF">):</span></span>
<span class="line"><span style="color:#C792EA">    def</span><span style="color:#82AAFF"> __init__</span><span style="color:#89DDFF">(</span><span style="color:#F07178;font-style:italic">self</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> n_classes</span><span style="color:#89DDFF">):</span></span>
<span class="line"><span style="color:#FFCB6B">        super</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">MalwareClassifier</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> self</span><span style="color:#89DDFF">).</span><span style="color:#82AAFF">__init__</span><span style="color:#89DDFF">()</span></span>
<span class="line"><span style="color:#676E95;font-style:italic">        # Load pretrained ResNet50</span></span>
<span class="line"><span style="color:#BABED8">        self</span><span style="color:#89DDFF">.</span><span style="color:#F07178">resnet</span><span style="color:#89DDFF"> =</span><span style="color:#BABED8"> models</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">resnet50</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">weights</span><span style="color:#89DDFF">=</span><span style="color:#89DDFF">'</span><span style="color:#C3E88D">DEFAULT</span><span style="color:#89DDFF">'</span><span style="color:#89DDFF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic">        # Freeze ResNet parameters</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        for</span><span style="color:#BABED8"> param </span><span style="color:#89DDFF;font-style:italic">in</span><span style="color:#BABED8"> self</span><span style="color:#89DDFF">.</span><span style="color:#F07178">resnet</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">parameters</span><span style="color:#89DDFF">():</span></span>
<span class="line"><span style="color:#BABED8">            param</span><span style="color:#89DDFF">.</span><span style="color:#F07178">requires_grad</span><span style="color:#89DDFF"> =</span><span style="color:#89DDFF"> False</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic">        # Replace the last fully connected layer</span></span>
<span class="line"><span style="color:#BABED8">        num_features </span><span style="color:#89DDFF">=</span><span style="color:#BABED8"> self</span><span style="color:#89DDFF">.</span><span style="color:#F07178">resnet</span><span style="color:#89DDFF">.</span><span style="color:#F07178">fc</span><span style="color:#89DDFF">.</span><span style="color:#F07178">in_features</span></span>
<span class="line"><span style="color:#BABED8">        self</span><span style="color:#89DDFF">.</span><span style="color:#F07178">resnet</span><span style="color:#89DDFF">.</span><span style="color:#F07178">fc</span><span style="color:#89DDFF"> =</span><span style="color:#BABED8"> nn</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">Sequential</span><span style="color:#89DDFF">(</span></span>
<span class="line"><span style="color:#82AAFF">            nn</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">Linear</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">num_features</span><span style="color:#89DDFF">,</span><span style="color:#82AAFF"> HIDDEN_LAYER_SIZE</span><span style="color:#89DDFF">),</span></span>
<span class="line"><span style="color:#82AAFF">            nn</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">ReLU</span><span style="color:#89DDFF">(),</span></span>
<span class="line"><span style="color:#82AAFF">            nn</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">Linear</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">HIDDEN_LAYER_SIZE</span><span style="color:#89DDFF">,</span><span style="color:#82AAFF"> n_classes</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#89DDFF">        )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">    def</span><span style="color:#82AAFF"> forward</span><span style="color:#89DDFF">(</span><span style="color:#F07178;font-style:italic">self</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> x</span><span style="color:#89DDFF">):</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        return</span><span style="color:#BABED8"> self</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">resnet</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">x</span><span style="color:#89DDFF">)</span></span></code></pre>
<h2 id="training-the-model">Training the model</h2>
<p>Now we need to specify the loss function and the optimizer to train the model and train the model using forward and backward propagation, compute the loss function and optimize the gradient using the optimizer to reduce the loss at each step. The following code captures the training process:</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#89DDFF;font-style:italic">import</span><span style="color:#BABED8"> torch</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">import</span><span style="color:#BABED8"> time</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">def</span><span style="color:#82AAFF"> train</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">model</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> train_loader</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> n_epochs</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> verbose</span><span style="color:#89DDFF">=False):</span></span>
<span class="line"><span style="color:#BABED8">    model</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">train</span><span style="color:#89DDFF">()</span></span>
<span class="line"><span style="color:#BABED8">    criterion </span><span style="color:#89DDFF">=</span><span style="color:#BABED8"> torch</span><span style="color:#89DDFF">.</span><span style="color:#F07178">nn</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">CrossEntropyLoss</span><span style="color:#89DDFF">()</span></span>
<span class="line"><span style="color:#BABED8">    optimizer </span><span style="color:#89DDFF">=</span><span style="color:#BABED8"> torch</span><span style="color:#89DDFF">.</span><span style="color:#F07178">optim</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">Adam</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">model</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">parameters</span><span style="color:#89DDFF">())</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8">    training_data </span><span style="color:#89DDFF">=</span><span style="color:#89DDFF"> {</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">accuracy</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">:</span><span style="color:#89DDFF"> [],</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">loss</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">:</span><span style="color:#89DDFF"> []}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">    for</span><span style="color:#BABED8"> epoch </span><span style="color:#89DDFF;font-style:italic">in</span><span style="color:#82AAFF"> range</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">n_epochs</span><span style="color:#89DDFF">):</span></span>
<span class="line"><span style="color:#BABED8">        running_loss </span><span style="color:#89DDFF">=</span><span style="color:#F78C6C"> 0</span></span>
<span class="line"><span style="color:#BABED8">        n_total </span><span style="color:#89DDFF">=</span><span style="color:#F78C6C"> 0</span></span>
<span class="line"><span style="color:#BABED8">        n_correct </span><span style="color:#89DDFF">=</span><span style="color:#F78C6C"> 0</span></span>
<span class="line"><span style="color:#BABED8">        checkpoint </span><span style="color:#89DDFF">=</span><span style="color:#BABED8"> time</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">time</span><span style="color:#89DDFF">()</span><span style="color:#89DDFF"> *</span><span style="color:#F78C6C"> 1000</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        for</span><span style="color:#BABED8"> inputs</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> labels </span><span style="color:#89DDFF;font-style:italic">in</span><span style="color:#BABED8"> train_loader</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#BABED8">            optimizer</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">zero_grad</span><span style="color:#89DDFF">()</span></span>
<span class="line"><span style="color:#BABED8">            outputs </span><span style="color:#89DDFF">=</span><span style="color:#82AAFF"> model</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">inputs</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">            loss </span><span style="color:#89DDFF">=</span><span style="color:#82AAFF"> criterion</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">outputs</span><span style="color:#89DDFF">,</span><span style="color:#82AAFF"> labels</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">            loss</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">backward</span><span style="color:#89DDFF">()</span></span>
<span class="line"><span style="color:#BABED8">            optimizer</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">step</span><span style="color:#89DDFF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8">            _</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> predicted </span><span style="color:#89DDFF">=</span><span style="color:#BABED8"> outputs</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">max</span><span style="color:#89DDFF">(</span><span style="color:#F78C6C">1</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">            n_total </span><span style="color:#89DDFF">+=</span><span style="color:#BABED8"> labels</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">size</span><span style="color:#89DDFF">(</span><span style="color:#F78C6C">0</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">            n_correct </span><span style="color:#89DDFF">+=</span><span style="color:#BABED8"> predicted</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">eq</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">labels</span><span style="color:#89DDFF">).</span><span style="color:#82AAFF">sum</span><span style="color:#89DDFF">().</span><span style="color:#82AAFF">item</span><span style="color:#89DDFF">()</span></span>
<span class="line"><span style="color:#BABED8">            running_loss </span><span style="color:#89DDFF">+=</span><span style="color:#BABED8"> loss</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">item</span><span style="color:#89DDFF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8">        epoch_loss </span><span style="color:#89DDFF">=</span><span style="color:#BABED8"> running_loss </span><span style="color:#89DDFF">/</span><span style="color:#82AAFF"> len</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">train_loader</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">        epoch_duration </span><span style="color:#89DDFF">=</span><span style="color:#FFCB6B"> int</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">time</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">time</span><span style="color:#89DDFF">()</span><span style="color:#89DDFF"> *</span><span style="color:#F78C6C"> 1000</span><span style="color:#89DDFF"> -</span><span style="color:#82AAFF"> checkpoint</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">        epoch_accuracy </span><span style="color:#89DDFF">=</span><span style="color:#82AAFF"> compute_accuracy</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">n_correct</span><span style="color:#89DDFF">,</span><span style="color:#82AAFF"> n_total</span><span style="color:#89DDFF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8">        training_data</span><span style="color:#89DDFF">[</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">accuracy</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">].</span><span style="color:#82AAFF">append</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">epoch_accuracy</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">        training_data</span><span style="color:#89DDFF">[</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">loss</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">].</span><span style="color:#82AAFF">append</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">epoch_loss</span><span style="color:#89DDFF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        if</span><span style="color:#BABED8"> verbose</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#82AAFF">            print</span><span style="color:#89DDFF">(</span><span style="color:#C792EA">f</span><span style="color:#C3E88D">"[i] Epoch </span><span style="color:#F78C6C">{</span><span style="color:#82AAFF">epoch</span><span style="color:#89DDFF">+</span><span style="color:#F78C6C">1}</span><span style="color:#C3E88D"> of </span><span style="color:#F78C6C">{</span><span style="color:#82AAFF">n_epochs</span><span style="color:#F78C6C">}</span><span style="color:#C3E88D">: Acc: </span><span style="color:#F78C6C">{</span><span style="color:#82AAFF">epoch_accuracy</span><span style="color:#C792EA">:.2f</span><span style="color:#F78C6C">}</span><span style="color:#C3E88D">% Loss: </span><span style="color:#F78C6C">{</span><span style="color:#82AAFF">epoch_loss</span><span style="color:#C792EA">:.4f</span><span style="color:#F78C6C">}</span><span style="color:#C3E88D"> (Took </span><span style="color:#F78C6C">{</span><span style="color:#82AAFF">epoch_duration</span><span style="color:#F78C6C">}</span><span style="color:#C3E88D"> ms)."</span><span style="color:#89DDFF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">    return</span><span style="color:#BABED8"> training_data</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">def</span><span style="color:#82AAFF"> compute_accuracy</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">n_correct</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> n_total</span><span style="color:#89DDFF">):</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">    return</span><span style="color:#82AAFF"> round</span><span style="color:#89DDFF">(</span><span style="color:#F78C6C">100</span><span style="color:#89DDFF"> *</span><span style="color:#82AAFF"> n_correct </span><span style="color:#89DDFF">/</span><span style="color:#82AAFF"> n_total</span><span style="color:#89DDFF">,</span><span style="color:#F78C6C"> 2</span><span style="color:#89DDFF">)</span></span></code></pre>
<p>When the model is trained, we should see an output like:</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="plaintext"><code><span class="line"><span>[i] Starting Training...</span></span>
<span class="line"><span>[i] Epoch 1 of 10: Acc: 60.52% Loss: 1.4468 (Took 69302 ms).</span></span>
<span class="line"><span>[i] Epoch 2 of 10: Acc: 87.71% Loss: 0.4122 (Took 67878 ms).</span></span>
<span class="line"><span>[i] Epoch 3 of 10: Acc: 90.44% Loss: 0.2690 (Took 66773 ms).</span></span>
<span class="line"><span>[i] Epoch 4 of 10: Acc: 92.40% Loss: 0.2167 (Took 61625 ms).</span></span>
<span class="line"><span>[i] Epoch 5 of 10: Acc: 93.98% Loss: 0.1738 (Took 62859 ms).</span></span>
<span class="line"><span>[i] Epoch 6 of 10: Acc: 93.70% Loss: 0.1691 (Took 225566 ms).</span></span>
<span class="line"><span>[i] Epoch 7 of 10: Acc: 94.14% Loss: 0.1593 (Took 188704 ms).</span></span>
<span class="line"><span>[i] Epoch 8 of 10: Acc: 96.05% Loss: 0.1161 (Took 60817 ms).</span></span>
<span class="line"><span>[i] Epoch 9 of 10: Acc: 96.80% Loss: 0.1037 (Took 60946 ms).</span></span>
<span class="line"><span>[i] Epoch 10 of 10: Acc: 96.59% Loss: 0.0977 (Took 60999 ms).</span></span></code></pre>
<p>Each time the forward-backward propagation process happens, the overall accuracy of the CNN is improved and the loss is minimized.</p>
<h2 id="model-evaluation">Model evaluation</h2>
<p>Once the model is trained with the training set, we need to evaluate how well it generalizes to unseen data. We do so by telling the model to don’t optimize for gradient and to be in eval mode:</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#C792EA">def</span><span style="color:#82AAFF"> predict</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">model</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> test_data</span><span style="color:#89DDFF">):</span></span>
<span class="line"><span style="color:#BABED8">    model</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">eval</span><span style="color:#89DDFF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">    with</span><span style="color:#BABED8"> torch</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">no_grad</span><span style="color:#89DDFF">():</span></span>
<span class="line"><span style="color:#BABED8">        output </span><span style="color:#89DDFF">=</span><span style="color:#82AAFF"> model</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">test_data</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">        _</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> predicted </span><span style="color:#89DDFF">=</span><span style="color:#BABED8"> torch</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">max</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">output</span><span style="color:#89DDFF">.</span><span style="color:#F07178">data</span><span style="color:#89DDFF">,</span><span style="color:#F78C6C"> 1</span><span style="color:#89DDFF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">    return</span><span style="color:#BABED8"> predicted</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA">def</span><span style="color:#82AAFF"> evaluate</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">model</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> test_loader</span><span style="color:#89DDFF">):</span></span>
<span class="line"><span style="color:#BABED8">    model</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">eval</span><span style="color:#89DDFF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8">    n_correct </span><span style="color:#89DDFF">=</span><span style="color:#F78C6C"> 0</span></span>
<span class="line"><span style="color:#BABED8">    n_total </span><span style="color:#89DDFF">=</span><span style="color:#F78C6C"> 0</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">    with</span><span style="color:#BABED8"> torch</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">no_grad</span><span style="color:#89DDFF">():</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        for</span><span style="color:#BABED8"> data</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> target </span><span style="color:#89DDFF;font-style:italic">in</span><span style="color:#BABED8"> test_loader</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#BABED8">            predicted </span><span style="color:#89DDFF">=</span><span style="color:#82AAFF"> predict</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">model</span><span style="color:#89DDFF">,</span><span style="color:#82AAFF"> data</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">            n_total </span><span style="color:#89DDFF">+=</span><span style="color:#BABED8"> target</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">size</span><span style="color:#89DDFF">(</span><span style="color:#F78C6C">0</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">            n_correct </span><span style="color:#89DDFF">+=</span><span style="color:#89DDFF"> (</span><span style="color:#BABED8">predicted </span><span style="color:#89DDFF">==</span><span style="color:#BABED8"> target</span><span style="color:#89DDFF">).</span><span style="color:#82AAFF">sum</span><span style="color:#89DDFF">().</span><span style="color:#82AAFF">item</span><span style="color:#89DDFF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8">    accuracy </span><span style="color:#89DDFF">=</span><span style="color:#82AAFF"> compute_accuracy</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">n_correct</span><span style="color:#89DDFF">,</span><span style="color:#82AAFF"> n_total</span><span style="color:#89DDFF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">    return</span><span style="color:#BABED8"> accuracy</span></span></code></pre>
<p>The achieved accuracy is quite low, around 86%, however this was only a proof-of-concept.</p>
<p>If more accuracy is required, we should go an train all the weights of the CNN which will increase a lot the training time specially without GPUs.</p>
<p>When we’re satisfied with the results, we can save the model:</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#C792EA">def</span><span style="color:#82AAFF"> save_model</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">model</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> path</span><span style="color:#89DDFF">):</span></span>
<span class="line"><span style="color:#BABED8">	model_scripted </span><span style="color:#89DDFF">=</span><span style="color:#BABED8"> torch</span><span style="color:#89DDFF">.</span><span style="color:#F07178">jit</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">script</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">model</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">	model_scripted</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">save</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">path</span><span style="color:#89DDFF">)</span></span></code></pre> </div> </article> </div>  </div> </article>  <footer class="flex justify-center items-center w-full px-16 h-28 border-t-2"> 2025 Adrian Galera
</footer> </main>    </body> </html> <script type="module">const t=()=>{function r(o,a){o.forEach(s=>{const e=document.querySelector(`aside a[href="#${s.target.id}"]`);s.isIntersecting?(e?.classList.remove("bg-slate-200","dark:bg-slate-800"),e?.classList.add("bg-indigo-600","dark:bg-indigo-700","text-white","font-bold","transition-colors","duration-200")):(e?.classList.add("bg-slate-200","dark:bg-slate-800"),e?.classList.remove("bg-indigo-600","dark:bg-indigo-700","text-white","font-bold","transition-colors","duration-200"))})}const i=document.querySelectorAll("div.prose h1, div.prose h2, div.prose h3, div.prose h4, div.prose h5, div.prose h6"),n={root:null,rootMargin:" 15% 0px 0% 0px ",threshold:1},d=new IntersectionObserver(r,n);i.forEach(o=>{d.observe(o)})};t();document.addEventListener("astro:after-swap",t);</script>