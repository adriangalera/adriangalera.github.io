<!DOCTYPE html><html lang="en" class="scroll-smooth" data-astro-cid-37fxchfa> <head><!-- ViewTransitions  --><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><script type="module" src="/_astro/ClientRouter.astro_astro_type_script_index_0_lang.CMTcOisY.js"></script> <!-- Global Metadata --> <meta charset="utf-8"> <meta name="viewport" content="width=device-width,initial-scale=1"> <link rel="icon" type="image/svg+xml" href="/favicon.svg"> <meta name="generator" content="Astro v5.5.4"> <!-- Canonical URL --> <link rel="canonical" href="https://www.agalera.eu/bark-detector/"> <!-- SEO --> <meta name="title" content="Implementing a dog bark detector • agalera.eu"> <meta name="description" content="Using machine learning with python to detect when my dog barks and send a telegram message when it happens"> <meta name="author" content="Adrian Galera"> <!-- Open Graph / Facebook --> <meta property="og:type" content="article"> <meta property="og:url" content="https://www.agalera.eu/bark-detector/"> <meta property="og:title" content="Implementing a dog bark detector"> <meta property="og:description" content="Using machine learning with python to detect when my dog barks and send a telegram message when it happens"> <meta property="og:image" content="https://www.agalera.eu/_astro/featured-image.DDIy7UjZ.jpg">  <meta property="article:author" content="Adrian Galera"> <meta property="article:published_time" content="2021-07-18T00:00:00.000Z">  <!-- Twitter --> <meta property="twitter:card" content="summary_large_image"> <meta property="twitter:url" content="https://www.agalera.eu/bark-detector/"> <meta property="twitter:title" content="Implementing a dog bark detector"> <meta property="twitter:description" content="Using machine learning with python to detect when my dog barks and send a telegram message when it happens"> <meta property="twitter:image" content="https://www.agalera.eu/_astro/featured-image.DDIy7UjZ.jpg"> <!-- RSS auto-discovery --> <link rel="alternate" type="application/rss+xml" title="agalera.eu" href="/rss.xml"> <!-- Google tag (gtag.js) --> <script async src="https://www.googletagmanager.com/gtag/js?id=G-S8VGYBN25C"></script> <script type="module">const n=window.location.hostname;n.includes("agalera.eu")||(console.log("Disabling analytics..."),window["ga-disable-G-S8VGYBN25C"]=!0);window.dataLayer=window.dataLayer||[];function a(){dataLayer.push(arguments)}a("js",new Date);a("config","G-S8VGYBN25C");</script> <!-- Primary Meta Tags --> <title>Implementing a dog bark detector • agalera.eu</title><script>
	function getTheme() {
		const storedTheme = typeof localStorage !== 'undefined' && localStorage.getItem('theme')

		return (
			storedTheme || (window.matchMedia('(prefers-color-scheme: light)').matches ? 'dark' : 'light')
		)
	}

	function setTheme(newTheme) {
		const html = document.documentElement
		const isDark = newTheme === 'dark'

		html.classList.toggle('dark', isDark)
		html.classList.toggle('light', !isDark)

		localStorage.setItem('theme', newTheme)
	}

	// set initial theme
	setTheme(getTheme())
	document.addEventListener('astro:after-swap', () => setTheme(getTheme()))

	document.addEventListener('theme-change', (e) => {
		setTheme(e.detail.theme)
	})
</script><script>
	if (!('animations' in localStorage)) {
		localStorage.setItem('animations', 'true')
	} else {
		localStorage.setItem('animations', 'false')
	}
</script><link rel="stylesheet" href="/_astro/_slug_.zXFjmf5d.css"></head> <body class="bg-white text-stone-950 dark:bg-[#0a0910] dark:text-white" data-astro-cid-37fxchfa> <main class="px-5 sm:mx-auto sm:max-w-2xl sm:px-8 lg:px-0 antialiased md:max-w-6xl grid gap-12 mt-4 overflow-hidden md:overflow-visible" data-astro-cid-37fxchfa> <header class="relative flex items-center h-12 font-semibold"> <a class="text-lg mr-auto" href="/">Home</a> <div id="astro-header-drawer" class="shadow rounded-l-lg md:bg-transparent dark:md:bg-transparent bg-white dark:bg-[#0a0910] md:shadow-none md:rounded-none md:border-none md:h-auto md:static absolute transition-transform duration-300 ease-in translate-x-96 md:translate-x-0 top-12 -right-5 pl-4 pt-6 pb-4 md:p-0 h-[200px] w-[200px] z-50"> <nav class="flex h-full flex-col justify-between gap-12 text-left md:flex-row md:w-full md:gap-5"> <div class="flex flex-col gap-8 md:flex-row md:border-r-2 border-black pr-4 dark:border-white"> <a href="/tags" class="text-opacity-60 flex items-center gap-1 text-2xl md:text-base" rel="noopener noreferrer ">  <svg xmlns="http://www.w3.org/2000/svg" class="w-8 md:w-6" viewBox="0 0 24 24" stroke-width="1.25" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M7.859 6h-2.834a2.025 2.025 0 0 0 -2.025 2.025v2.834c0 .537 .213 1.052 .593 1.432l6.116 6.116a2.025 2.025 0 0 0 2.864 0l2.834 -2.834a2.025 2.025 0 0 0 0 -2.864l-6.117 -6.116a2.025 2.025 0 0 0 -1.431 -.593z"></path> <path d="M17.573 18.407l2.834 -2.834a2.025 2.025 0 0 0 0 -2.864l-7.117 -7.116"></path> <path d="M6 9h-.01"></path> </svg> Tags
 </a> </div> <div class="flex justify-center items-center md:justify-end gap-4 md:p-0"> <a href="https://github.com/adriangalera" class="text-opacity-60" rel="noopener noreferrer " target="_blank" aria-label="Github">  <span><svg xmlns="http://www.w3.org/2000/svg" class="w-8 md:w-6" viewBox="0 0 24 24" stroke-width="1.3" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5"></path> </svg> </span>  </a><a href="https://www.linkedin.com/in/adriangalera" class="text-opacity-60" rel="noopener noreferrer " target="_blank" aria-label="Twitter">  <span><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-linkedin" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M4 4m0 2a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2z"></path> <path d="M8 11l0 5"></path> <path d="M8 8l0 .01"></path> <path d="M12 16l0 -5"></path> <path d="M16 16v-3a2 2 0 0 0 -4 0"></path> </svg> </span>  </a> </div> </nav> </div> <div class="flex items-center gap-3 md:pl-3" data-astro-transition-persist="navbar"> <div> <site-search id="search" class="ms-auto"> <button data-open-modal disabled class="flex items-center justify-center rounded-md gap-1"> <svg aria-label="search" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"> <path stroke="none" d="M0 0h24v24H0z"></path> <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6"></path> </svg> <!-- <span class='md:hidden text-2xl'> Search</span> --> </button> <dialog aria-label="search" class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-white dark:bg-[#0a0910ec] shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md opacity-0"> <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6"> <button data-close-modal class="ms-auto cursor-pointer rounded-full bg-black text-white px-4 py-2 dark:bg-white dark:text-black">Close</button> <div class="search-container dark:text-white"> <div id="pagefind__search"></div> </div> </div> </dialog> </site-search> <script type="module" src="/_astro/Search.astro_astro_type_script_index_0_lang.NYKLwWpr.js"></script>  </div> <script type="module">class r extends HTMLElement{constructor(){super();const e=this.querySelector("button");e&&e.addEventListener("click",t=>{if(t.currentTarget instanceof HTMLButtonElement){let n=t.currentTarget.getAttribute("aria-pressed")==="true",s=new CustomEvent("theme-change",{detail:{theme:n?"light":"dark"}});document.dispatchEvent(s),e.setAttribute("aria-pressed",String(!n))}})}}"customElements"in window&&customElements.define("theme-toggle",r);</script> <theme-toggle class="relative h-6 w-6"> <button id="toggle-theme" class="group"> <span class="absolute left-0 right-0 top-0 opacity-0 group-aria-pressed:opacity-100"> <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-sun-high" width="24" height="24" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M14.828 14.828a4 4 0 1 0 -5.656 -5.656a4 4 0 0 0 5.656 5.656z"></path> <path d="M6.343 17.657l-1.414 1.414"></path> <path d="M6.343 6.343l-1.414 -1.414"></path> <path d="M17.657 6.343l1.414 -1.414"></path> <path d="M17.657 17.657l1.414 1.414"></path> <path d="M4 12h-2"></path> <path d="M12 4v-2"></path> <path d="M20 12h2"></path> <path d="M12 20v2"></path> </svg> </span> <span class="absolute left-0 right-0 top-0 opacity-0 group-aria-[pressed=false]:opacity-100"> <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-moon" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.25" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path> </svg> </span> </button> </theme-toggle> <script>
	const button = document.getElementById('toggle-theme')

	function setButtonPresssed() {
		const bodyThemeIsDark = document.documentElement.classList.contains('dark')
		button.setAttribute('aria-pressed', String(bodyThemeIsDark))
	}
	setButtonPresssed()
</script> <button id="astro-header-drawer-button" type="button" class="md:ml-6 md:hidden"> <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-menu-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.25" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M4 6l16 0"></path> <path d="M4 12l16 0"></path> <path d="M4 18l16 0"></path> </svg> <span class="sr-only">Show Menu</span> </button> </div> </header> <script type="module">document.addEventListener("click",e=>{const t=document.getElementById("astro-header-drawer"),n=document.getElementById("astro-header-drawer-button");t?.contains(e.target)||n?.contains(e.target)?t?.classList.toggle("translate-x-96"):t?.classList.add("translate-x-96")});</script>  <article class="min-w-full md:py-4 sm:max-w-none md:max-w-none"> <header class="mb-3 flex flex-col justify-center items-center gap-6"> <div class="flex flex-col gap-2"> <div class="flex items-center justify-center gap-x-1"> <p class="text-center text-sm text-opacity-50">
Published <time class="text-sm font-bold text-opacity-60" datetime="2021-07-18T00:00:00.000Z"> Jul 18, 2021 </time> </p> <p class="text-center text-sm text-opacity-50 font-bold">
- 8 min read </p> </div> <h1 class="text-center text-4xl md:text-6xl md:pb-2.5 font-semibold"> Implementing a dog bark detector </h1> </div> <div class="flex flex-wrap justify-center items-center gap-2 gap-y-4 md:gap-5"> <a href="/tags/python" aria-label="python"> <span class="bg-indigo-600 font-semibold text-white dark:bg-indigo-900 dark:text-white shadow text-sm w-fit px-2 py-1 md:px-5 md:py-2 rounded-full"> python </span> </a><a href="/tags/ml" aria-label="ml"> <span class="bg-indigo-600 font-semibold text-white dark:bg-indigo-900 dark:text-white shadow text-sm w-fit px-2 py-1 md:px-5 md:py-2 rounded-full"> ml </span> </a><a href="/tags/audio" aria-label="audio"> <span class="bg-indigo-600 font-semibold text-white dark:bg-indigo-900 dark:text-white shadow text-sm w-fit px-2 py-1 md:px-5 md:py-2 rounded-full"> audio </span> </a><a href="/tags/scikit" aria-label="scikit"> <span class="bg-indigo-600 font-semibold text-white dark:bg-indigo-900 dark:text-white shadow text-sm w-fit px-2 py-1 md:px-5 md:py-2 rounded-full"> scikit </span> </a><a href="/tags/librosa" aria-label="librosa"> <span class="bg-indigo-600 font-semibold text-white dark:bg-indigo-900 dark:text-white shadow text-sm w-fit px-2 py-1 md:px-5 md:py-2 rounded-full"> librosa </span> </a><a href="/tags/raspberry-pi" aria-label="raspberry-pi"> <span class="bg-indigo-600 font-semibold text-white dark:bg-indigo-900 dark:text-white shadow text-sm w-fit px-2 py-1 md:px-5 md:py-2 rounded-full"> raspberry-pi </span> </a><a href="/tags/vlc" aria-label="vlc"> <span class="bg-indigo-600 font-semibold text-white dark:bg-indigo-900 dark:text-white shadow text-sm w-fit px-2 py-1 md:px-5 md:py-2 rounded-full"> vlc </span> </a><a href="/tags/bash" aria-label="bash"> <span class="bg-indigo-600 font-semibold text-white dark:bg-indigo-900 dark:text-white shadow text-sm w-fit px-2 py-1 md:px-5 md:py-2 rounded-full"> bash </span> </a> </div> </header> <img src="/_astro/featured-image.DDIy7UjZ_2kU1pQ.jpg" loading="eager" alt="img of Implementing a dog bark detector" width="1000" height="500" decoding="async" class="rounded-md w-full max-h-[300px]  md:max-h-[500px] my-8 object-cover"> <hr> <div>  <div class="grid grid-cols-1 md:grid-cols-[20%_auto] gap-10 mt-8"> <!-- aside  --> <aside class="md:flex flex-col gap-8 hidden"> <div class="flex flex-col gap-2"> <span class="mb-1 font-bold text-2xl">Share</span> <ul class="flex gap-3 text-black dark:text-white"> <li> <a href="https://twitter.com/intent/tweet?text=Share this post https://www.agalera.eu/bark-detector/" aria-label="Share on Twitter"><!--?xml version="1.0" ?--><svg height="32px" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;" version="1.1" viewBox="0 0 512 512" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g><path d="M448,512l-384,0c-35.328,0 -64,-28.672 -64,-64l0,-384c0,-35.328 28.672,-64 64,-64l384,0c35.328,0 64,28.672 64,64l0,384c0,35.328 -28.672,64 -64,64Z" id="Dark_Blue" style="fill:#1da1f2;fill-rule:nonzero;"></path><path d="M196.608,386.048c120.704,0 186.752,-100.096 186.752,-186.752c0,-2.816 0,-5.632 -0.128,-8.448c12.8,-9.216 23.936,-20.864 32.768,-34.048c-11.776,5.248 -24.448,8.704 -37.76,10.368c13.568,-8.064 23.936,-20.992 28.928,-36.352c-12.672,7.552 -26.752,12.928 -41.728,15.872c-12.032,-12.8 -29.056,-20.736 -47.872,-20.736c-36.224,0 -65.664,29.44 -65.664,65.664c0,5.12 0.64,10.112 1.664,14.976c-54.528,-2.688 -102.912,-28.928 -135.296,-68.608c-5.632,9.728 -8.832,20.992 -8.832,33.024c0,22.784 11.648,42.88 29.184,54.656c-10.752,-0.384 -20.864,-3.328 -29.696,-8.192l0,0.896c0,31.744 22.656,58.368 52.608,64.384c-5.504,1.536 -11.264,2.304 -17.28,2.304c-4.224,0 -8.32,-0.384 -12.288,-1.152c8.32,26.112 32.64,45.056 61.312,45.568c-22.528,17.664 -50.816,28.16 -81.536,28.16c-5.248,0 -10.496,-0.256 -15.616,-0.896c28.928,18.432 63.488,29.312 100.48,29.312" id="Logo__x2014__FIXED" style="fill:#fff;fill-rule:nonzero;"></path></g></svg></a> </li> <li> <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://www.agalera.eu/bark-detector/" aria-label="Share on LinkedIn"> <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-linkedin" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"> <path stroke="none" d="M0 0h24v24H0z" fill="none"></path> <path d="M4 4m0 2a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v12a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2z"></path> <path d="M8 11l0 5"></path> <path d="M8 8l0 .01"></path> <path d="M12 16l0 -5"></path> <path d="M16 16v-3a2 2 0 0 0 -4 0"></path> </svg></a> </li> </ul> </div> <div class="sticky top-24 self-start hidden md:block transition-all duration-200"> <nav class="max-w-xs dark:text-black"> <h2 class="font-bold mb-3 text-2xl dark:text-white">Index</h2> <ul class="[text-wrap:balance] flex flex-col gap-1"> <li class="flex flex-col"> <a href="#basics" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> Basics </a> <ul class="ml-3"> <li class="flex flex-col"> <a href="#time-representation" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> Time representation </a>  </li><li class="flex flex-col"> <a href="#frequency-representation" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> Frequency representation </a>  </li><li class="flex flex-col"> <a href="#mel-frequency-cepstral-co-efficients-mfcc" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> Mel Frequency Cepstral Co-efficients (MFCC) </a>  </li> </ul> </li><li class="flex flex-col"> <a href="#getting-the-dataset" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> Getting the dataset </a>  </li><li class="flex flex-col"> <a href="#training-the-model" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> Training the model </a> <ul class="ml-3"> <li class="flex flex-col"> <a href="#characterization-of-a-bark" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> Characterization of a bark </a>  </li><li class="flex flex-col"> <a href="#labelling-the-dataset" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> Labelling the dataset </a>  </li><li class="flex flex-col"> <a href="#dataset-imbalance" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> Dataset imbalance </a>  </li> </ul> </li><li class="flex flex-col"> <a href="#using-the-training-model" class="bg-slate-200 dark:bg-slate-800 dark:hover:bg-indigo-400 hover:bg-indigo-300 hover:text-white py-1 px-4 dark:text-white rounded-full mb-2 first-letter:uppercase w-fit line-clamp-2"> Using the training model </a>  </li> </ul> </nav> </div> </aside> <!-- post --> <article class="max-w-full w-full"> <div class="prose prose-lg md:prose-xl dark:prose-invert mb-12 min-w-full"> <p>My dog has a little bit of separation anxiety so when we leave him alone, he barks some times.</p>
<p>We are training him to be home-alone and we want to know if he barks or not when we are not home.</p>
<p>Let’s implement a bark detector!</p>
<h2 id="basics">Basics</h2>
<h3 id="time-representation">Time representation</h3>
<p>What is audio and how is its digital representation? It’s basically an array of float values containing a value from -1 to 1.</p>
<p><img alt="Sound wave" title="Sound wave" width="2050" height="1062" loading="lazy" decoding="async" src="/_astro/wave.D_rRHmNa_Gx8To.webp" ></p>
<ul>
<li>Temporal representation of an audio signal</li>
</ul>
<p>This representation shows the temporal evolution of the audio signal over time. This is very variable and it’s really difficult to extract any relevant feature from this representation.</p>
<h3 id="frequency-representation">Frequency representation</h3>
<p>So, instead of using the temporal representation, let’s observe the frequency representation:</p>
<p><img alt="Frequency representation" title="Frequency representation" width="1784" height="1166" loading="lazy" decoding="async" src="/_astro/stft.D2tTc5Mp_Z1mrCOC.webp" ></p>
<ul>
<li>Frequency representation of an audio signal</li>
</ul>
<p>The x axis is the time of the audio signal and the y axis is the values of the frequencies. Each color in the vertical axis correspond to a different value of the power on that certain frequency.</p>
<p>Note that the time of the plot is doubled respect with the time representation, this is because the signal is combined with itself to generate the frequency representation.</p>
<p>This representation shows the evolution of the different frequency amplitudes over time.</p>
<p>Without even listening the sound, we can try to analise it checking the time/frequency characteristic. We see some peaks in the time representation that match with high energy in the low frequencies.</p>
<p>The good thing about frequency representation is that it cancel noise because usually its energy is spread over all frequencies. Besides that, each sound has a characteristic frequency footprint. So, it’s very convinient to extract the features of the sound in the frequency domain.</p>
<h3 id="mel-frequency-cepstral-co-efficients-mfcc">Mel Frequency Cepstral Co-efficients (MFCC)</h3>
<p>Quoting from <a href="https://iq.opengenus.org/mfcc-audio/"></a><a href="https://iq.opengenus.org/mfcc-audio/">https://iq.opengenus.org/mfcc-audio/</a>:</p>
<blockquote>
<p>MFC is a representation of the short-term power spectrum of a sound, based on a linear cosine transform of a log power spectrum on a nonlinear mel scale of frequency.</p>
</blockquote>
<p>Ok, what does it mean? It’s an improved frequency representation but applying optimizations based on the characteristics of human hearing. Usually MFCC are obtained like this:</p>
<ol>
<li>Take the Fourier transform of the audio signal to get the frequency representation.</li>
<li>Map the powers of the spectrum to the <a href="https://en.wikipedia.org/wiki/Mel_scale">mel scale</a>. This scale approximates the spectrum to be more like what humans hear.</li>
<li>Take the logs of the powers at each of the mel frequencies.</li>
<li>Take the discrete cosine transform (DCT) of the list of mel log powers. This will remove redudant information as in non-changing information.</li>
<li>The MFCCs are the amplitudes of the resulting spectrum.</li>
</ol>
<p><img alt="MFCC" title="MFCC" width="1812" height="1294" loading="lazy" decoding="async" src="/_astro/mfcc.C07qrzEF_1Bihkk.webp" ></p>
<ul>
<li>MFCC representation of an audio signal</li>
</ul>
<p>We can use <a href="https://librosa.org/doc/latest/index.html">librosa</a> library to load the audio and extract the MFCC features.</p>
<p>The x axis is time, the y axis is the different MFCC coefficients computed (20 in this example). The color shows the value MFCC coefficient for certain time and coefficient.</p>
<p>It’s not obvious to see anything in this plot, but it represents the frequency information in a format the computer can use to understand the characteristics of this sound.</p>
<h2 id="getting-the-dataset">Getting the dataset</h2>
<p>In <a href="https://www.agalera.eu/standalone-app-raspberry-pi">this</a> article I describe the little device I made to feed my dog while I’m away. So I’ll re-use the same device and plug it an old unused webcam that has a microphone.</p>
<p>I did not want to complicate my life much and I created a simple script that uses vlc to stream the audio obtained by the webcam mic and store it as mp3. In order to analyse the files easier I run the script every minute so I have recordings of 60 seconds duration:</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="shell"><code><span class="line"><span style="color:#676E95;font-style:italic">#!/bin/bash</span></span>
<span class="line"><span style="color:#BABED8">TIMEOUT</span><span style="color:#89DDFF">=</span><span style="color:#C3E88D">60</span></span>
<span class="line"><span style="color:#BABED8">FILE_NAME</span><span style="color:#89DDFF">=</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">/home/pi/dogfeeder-audios/dogfeeder-audio-</span><span style="color:#89DDFF">$(</span><span style="color:#FFCB6B">date</span><span style="color:#C3E88D"> +</span><span style="color:#89DDFF">'</span><span style="color:#C3E88D">%Y_%m_%d_%H_%M_%S</span><span style="color:#89DDFF">')</span><span style="color:#C3E88D">.mp3</span><span style="color:#89DDFF">"</span></span>
<span class="line"><span style="color:#FFCB6B">timeout</span><span style="color:#89DDFF"> "</span><span style="color:#BABED8">$TIMEOUT</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D"> cvlc</span><span style="color:#C3E88D"> --no-video</span><span style="color:#C3E88D"> alsa://plughw:1</span><span style="color:#C3E88D"> --sout=</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">#transcode{vcodec=none,acodec=mp3,ab=128,</span></span>
<span class="line"><span style="color:#C3E88D">channels=2,samplerate=44100}:duplicate{dst=std{access=http,mux=mp3,dst=:8087},dst=std{access=file,mux=wav,</span></span>
<span class="line"><span style="color:#C3E88D">dst=</span><span style="color:#BABED8">$FILE_NAME</span><span style="color:#C3E88D">}}</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF"> &#x26;</span></span></code></pre>
<p>The syntax of vlc is really ugly :( . But if you read it carefully, you will see that we’re telling vlc to transcode the audio coming from <code>alsa://plughw:1</code> device (webcam microphone) to mp3 at 128 kbps (decent compression rate). After that, stream the generated mp3 via HTTP on port 8087 and store the mp3 data on the given filename.</p>
<p>In order to don’t flood the SD card of the Raspberry Pi I run the following script each 15 minutes. It gets the files older than 15 minutes, copy them to a NAS and remove them from the Raspberry Pi disk.</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="shell"><code><span class="line"><span style="color:#676E95;font-style:italic">#!/bin/bash</span></span>
<span class="line"><span style="color:#BABED8">MINUTES_ALLOWED</span><span style="color:#89DDFF">=</span><span style="color:#C3E88D">15</span></span>
<span class="line"><span style="color:#BABED8">FILES_TO_DELETE</span><span style="color:#89DDFF">=$(</span><span style="color:#FFCB6B">find</span><span style="color:#C3E88D"> /home/pi/dogfeeder-audios</span><span style="color:#C3E88D"> -type</span><span style="color:#C3E88D"> f</span><span style="color:#C3E88D"> -mmin</span><span style="color:#C3E88D"> +</span><span style="color:#89DDFF">"</span><span style="color:#BABED8">$MINUTES_ALLOWED</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D"> -exec</span><span style="color:#C3E88D"> ls</span><span style="color:#C3E88D"> {}</span><span style="color:#C3E88D"> +</span><span style="color:#89DDFF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">for</span><span style="color:#BABED8"> file </span><span style="color:#89DDFF;font-style:italic">in</span><span style="color:#BABED8"> $FILES_TO_DELETE</span><span style="color:#89DDFF">;</span><span style="color:#89DDFF;font-style:italic"> do</span></span>
<span class="line"><span style="color:#FFCB6B">    scp</span><span style="color:#89DDFF"> "</span><span style="color:#BABED8">$file</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D"> admin@diskstation.local:/volume1/data/dogfeeder-audios/.</span></span>
<span class="line"><span style="color:#FFCB6B">    rm</span><span style="color:#89DDFF"> "</span><span style="color:#BABED8">$file</span><span style="color:#89DDFF">"</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">done</span></span></code></pre>
<h2 id="training-the-model">Training the model</h2>
<p>I’ve been recording for 3 days and we made some exits to keep him alone. Up to this point we have enough data to train the model. However, we have <code>60 min * 24 h * 3 days = 4320 files</code> and need to classify them manually. Will we do that manually? Absolutely not!</p>
<p>We can pre-process the dataset and check for files that have something different than noise.</p>
<p><img alt="Signal with noise" title="Signal with noise" width="1648" height="1076" loading="lazy" decoding="async" src="/_astro/noise.lzjLROmE_S3Mzn.webp" ></p>
<ul>
<li>File with only noise</li>
</ul>
<p><img alt="Signal with unclassified audio event" title="Signal with unclassified audio event" width="2050" height="1062" loading="lazy" decoding="async" src="/_astro/wave.D_rRHmNa_Gx8To.webp" ></p>
<ul>
<li>File with unclassified audio event</li>
</ul>
<p>Since my dog’s barks are quite loud we can safely discard all files whose maximum amplitude is lower than 0.25. This way, we could reduce a lot the amount of files that need to be manually classified as bark.</p>
<h3 id="characterization-of-a-bark">Characterization of a bark</h3>
<p>As mentioned before, we’ll discard files whose amplitude is lower than 0.25. Listening to multiple files with bark, we can observe that each bark more or less lasts for 1 second.</p>
<p><img alt="Bark signal" title="Bark signal" width="2090" height="1194" loading="lazy" decoding="async" src="/_astro/bark.Dp1veZuh_Zhhbl3.webp" ></p>
<ul>
<li>Time representation of an audio signal containing a bark</li>
</ul>
<h3 id="labelling-the-dataset">Labelling the dataset</h3>
<p>So, the strategy for labelling the dataset will be:</p>
<ol>
<li>Download the whole dataset.</li>
<li>Discard the not interesting files (files without any sound event) by checking the maximum amplitude.</li>
<li>Extract chunks of 1 seconds from them, run again the algorithm to check sound events on the one-second chunks.</li>
<li>Manually listen to the chunks and classify them as bark or not. You can default the labelling to “Not Bark” and this way you only classify events that are barks.</li>
</ol>
<p>The implementation of this is quite simple: write every chunk filename in a CSV and and a 0 or 1 signaling the presence of a bark or not:</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="plaintext"><code><span class="line"><span>chunks/dogfeeder-audio-2021_07_16_18_49_01_23.wav,0</span></span>
<span class="line"><span>chunks/dogfeeder-audio-2021_07_16_18_49_01_24.wav,1</span></span>
<span class="line"><span>chunks/dogfeeder-audio-2021_07_16_18_49_01_25.wav,0</span></span></code></pre>
<p>Once we have the dataset labelled, we can go file by file and extract the MFCC features of every one-second file:</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#C792EA">def</span><span style="color:#82AAFF"> extract_mfcc</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">filename</span><span style="color:#89DDFF">):</span></span>
<span class="line"><span style="color:#BABED8">    y</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> __ </span><span style="color:#89DDFF">=</span><span style="color:#BABED8"> librosa</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">load</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">filename</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> mono</span><span style="color:#89DDFF">=True,</span><span style="color:#BABED8;font-style:italic"> sr</span><span style="color:#89DDFF">=</span><span style="color:#82AAFF">sample_rate</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">    mfcc_2D </span><span style="color:#89DDFF">=</span><span style="color:#BABED8"> librosa</span><span style="color:#89DDFF">.</span><span style="color:#F07178">feature</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">mfcc</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">y</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> sr</span><span style="color:#89DDFF">=</span><span style="color:#82AAFF">sample_rate</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> n_mfcc</span><span style="color:#89DDFF">=</span><span style="color:#F78C6C">100</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">    mfcc_1D </span><span style="color:#89DDFF">=</span><span style="color:#BABED8"> mfcc_2D</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">flatten</span><span style="color:#89DDFF">()</span></span>
<span class="line"><span style="color:#BABED8">    scaler </span><span style="color:#89DDFF">=</span><span style="color:#82AAFF"> MinMaxScaler</span><span style="color:#89DDFF">()</span></span>
<span class="line"><span style="color:#BABED8">    mfccs_sc </span><span style="color:#89DDFF">=</span><span style="color:#BABED8"> scaler</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">fit_transform</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">np</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">array</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">mfcc_1D</span><span style="color:#89DDFF">).</span><span style="color:#82AAFF">reshape</span><span style="color:#89DDFF">(-</span><span style="color:#F78C6C">1</span><span style="color:#89DDFF">,</span><span style="color:#F78C6C"> 1</span><span style="color:#89DDFF">))</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">    return</span><span style="color:#BABED8"> mfccs_sc</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">flatten</span><span style="color:#89DDFF">()</span></span></code></pre>
<p>MFCC values can go from [-Inf, Inf], however when I was playing with different algorithms, some of them did not accept negative values, so I scaled the values of MFCC to [0, Inf] using <code>MinMaxScaler</code>.</p>
<p>Once we have the MFCC features for all the dataset, we can split the dataset into training and test dataset using:</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#89DDFF;font-style:italic">from</span><span style="color:#BABED8"> sklearn</span><span style="color:#89DDFF">.</span><span style="color:#BABED8">model_selection </span><span style="color:#89DDFF;font-style:italic">import</span><span style="color:#BABED8"> train_test_split</span></span>
<span class="line"><span style="color:#BABED8">X_train</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> X_test</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> y_train</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> y_test </span><span style="color:#89DDFF">=</span><span style="color:#82AAFF"> train_test_split</span><span style="color:#89DDFF">(</span></span>
<span class="line"><span style="color:#82AAFF">        X</span><span style="color:#89DDFF">,</span><span style="color:#82AAFF"> Y</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> random_state</span><span style="color:#89DDFF">=</span><span style="color:#F78C6C">42</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> test_size</span><span style="color:#89DDFF">=</span><span style="color:#F78C6C">0.33</span><span style="color:#89DDFF">)</span></span></code></pre>
<p>After that, I’ve assesed the prediction performance of <code>Naive Bayes</code> classifier and <code>Logistic Regression</code> classifiers:</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#676E95;font-style:italic">    # Naive bayes</span></span>
<span class="line"><span style="color:#82AAFF">    print</span><span style="color:#89DDFF">(</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">Training naive bayes ...</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">    mnb </span><span style="color:#89DDFF">=</span><span style="color:#82AAFF"> MultinomialNB</span><span style="color:#89DDFF">().</span><span style="color:#82AAFF">fit</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">X_train</span><span style="color:#89DDFF">,</span><span style="color:#82AAFF"> y_train</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#82AAFF">    print</span><span style="color:#89DDFF">(</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">score on test: </span><span style="color:#89DDFF">"</span><span style="color:#89DDFF"> +</span><span style="color:#FFCB6B"> str</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">mnb</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">score</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">X_test</span><span style="color:#89DDFF">,</span><span style="color:#82AAFF"> y_test</span><span style="color:#89DDFF">)))</span></span>
<span class="line"><span style="color:#82AAFF">    print</span><span style="color:#89DDFF">(</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">score on train: </span><span style="color:#89DDFF">"</span><span style="color:#89DDFF"> +</span><span style="color:#FFCB6B"> str</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">mnb</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">score</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">X_train</span><span style="color:#89DDFF">,</span><span style="color:#82AAFF"> y_train</span><span style="color:#89DDFF">)))</span></span>
<span class="line"><span style="color:#82AAFF">    print</span><span style="color:#89DDFF">(</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">***************</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic">    # Logistic regression</span></span>
<span class="line"><span style="color:#82AAFF">    print</span><span style="color:#89DDFF">(</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">Training logistic regression ...</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">    lr </span><span style="color:#89DDFF">=</span><span style="color:#82AAFF"> LogisticRegression</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">max_iter</span><span style="color:#89DDFF">=</span><span style="color:#F78C6C">1000</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">    lr</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">fit</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">X_train</span><span style="color:#89DDFF">,</span><span style="color:#82AAFF"> y_train</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#82AAFF">    print</span><span style="color:#89DDFF">(</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">score on test: </span><span style="color:#89DDFF">"</span><span style="color:#89DDFF"> +</span><span style="color:#FFCB6B"> str</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">lr</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">score</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">X_test</span><span style="color:#89DDFF">,</span><span style="color:#82AAFF"> y_test</span><span style="color:#89DDFF">)))</span></span>
<span class="line"><span style="color:#82AAFF">    print</span><span style="color:#89DDFF">(</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">score on train: </span><span style="color:#89DDFF">"</span><span style="color:#89DDFF"> +</span><span style="color:#FFCB6B"> str</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">lr</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">score</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">X_train</span><span style="color:#89DDFF">,</span><span style="color:#82AAFF"> y_train</span><span style="color:#89DDFF">)))</span></span></code></pre>
<p>Getting a very good score with the logistic regression, I don’t remember exactly the numbers but were more or less:</p>
<ul>
<li>Score on test: 0.992</li>
<li>Score on traing: 0.996</li>
</ul>
<h3 id="dataset-imbalance">Dataset imbalance</h3>
<p>The number of events with barks will be very reduced compared with the events that does not contain a bark. This can present a huge problem depending on the machine learning algorithm returning a totally biased model.</p>
<p>In order to fix that, you can do two things:</p>
<ol>
<li>Oversample: create positive samples by synthetically creating new positive samples</li>
<li>Undersample: discard samples from the negative ones</li>
</ol>
<p>More info: <a href="https://towardsdatascience.com/having-an-imbalanced-dataset-here-is-how-you-can-solve-it-1640568947eb"></a><a href="https://towardsdatascience.com/having-an-imbalanced-dataset-here-is-how-you-can-solve-it-1640568947eb">https://towardsdatascience.com/having-an-imbalanced-dataset-here-is-how-you-can-solve-it-1640568947eb</a></p>
<p>I’ve used <code>SMOTE</code> (Synthetic Minority Over-sampling Technique) technique to perform the oversampling with very satisfactory results. In simple terms, SMOTE looks at the feature space for the minority class data points and considers its k nearest neighbours.</p>
<p>To do that I’ve used <a href="https://imbalanced-learn.org/stable/">imbalanced-learn</a> python libary and it’s really simple:</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#C792EA">def</span><span style="color:#82AAFF"> fix_imbalance</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">X</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> Y</span><span style="color:#89DDFF">):</span></span>
<span class="line"><span style="color:#BABED8">    over </span><span style="color:#89DDFF">=</span><span style="color:#82AAFF"> SMOTE</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">sampling_strategy</span><span style="color:#89DDFF">=</span><span style="color:#F78C6C">0.1</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">    under </span><span style="color:#89DDFF">=</span><span style="color:#82AAFF"> RandomUnderSampler</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">sampling_strategy</span><span style="color:#89DDFF">=</span><span style="color:#F78C6C">0.5</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">    steps </span><span style="color:#89DDFF">=</span><span style="color:#89DDFF"> [(</span><span style="color:#89DDFF">'</span><span style="color:#C3E88D">o</span><span style="color:#89DDFF">'</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> over</span><span style="color:#89DDFF">),</span><span style="color:#89DDFF"> (</span><span style="color:#89DDFF">'</span><span style="color:#C3E88D">u</span><span style="color:#89DDFF">'</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> under</span><span style="color:#89DDFF">)]</span></span>
<span class="line"><span style="color:#BABED8">    pipeline </span><span style="color:#89DDFF">=</span><span style="color:#82AAFF"> Pipeline</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">steps</span><span style="color:#89DDFF">=</span><span style="color:#82AAFF">steps</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">    X_fix</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> Y_fix </span><span style="color:#89DDFF">=</span><span style="color:#BABED8"> pipeline</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">fit_resample</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">X</span><span style="color:#89DDFF">,</span><span style="color:#82AAFF"> Y</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">    return</span><span style="color:#BABED8"> X_fix</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> Y_fix</span></span></code></pre>
<p>Note that the library also provides a module to perform majority under sampling. The two methods are combined in a pipeline to fix the dataset imbalance problem.</p>
<h2 id="using-the-training-model">Using the training model</h2>
<p>Now we have our logistic regression model trained and is working quite well. It’s time to put it on the Raspberry Pi.</p>
<p>First of all, we need a way to export the model outside of the training python code. In order to do that, I use the <a href="https://joblib.readthedocs.io/en/latest/">joblib</a> library:</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#676E95;font-style:italic"># Write the model</span></span>
<span class="line"><span style="color:#BABED8">lr </span><span style="color:#89DDFF">=</span><span style="color:#82AAFF"> LogisticRegression</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">max_iter</span><span style="color:#89DDFF">=</span><span style="color:#F78C6C">1000</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">lr</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">fit</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">X_train</span><span style="color:#89DDFF">,</span><span style="color:#82AAFF"> y_train</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">joblib</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">dump</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">lr</span><span style="color:#89DDFF">,</span><span style="color:#89DDFF"> '</span><span style="color:#C3E88D">lr.pkl</span><span style="color:#89DDFF">'</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> compress</span><span style="color:#89DDFF">=</span><span style="color:#F78C6C">9</span><span style="color:#89DDFF">)</span></span></code></pre>
<p>joblib serialize the object into that file and then Raspberry Pi can load the model object:</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#BABED8">model </span><span style="color:#89DDFF">=</span><span style="color:#BABED8"> joblib</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">load</span><span style="color:#89DDFF">(</span><span style="color:#89DDFF">'</span><span style="color:#C3E88D">lr.pkl</span><span style="color:#89DDFF">'</span><span style="color:#89DDFF">)</span></span></code></pre>
<p>Now we can retrieve the more recent fully recorded audio file:</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#C792EA">def</span><span style="color:#82AAFF"> last_fully_written_file</span><span style="color:#89DDFF">():</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">    return</span><span style="color:#BABED8"> audios_path </span><span style="color:#89DDFF">+</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">/</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF"> +</span><span style="color:#82AAFF"> sorted</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">os</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">listdir</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">audios_path</span><span style="color:#89DDFF">))[-</span><span style="color:#F78C6C">2</span><span style="color:#89DDFF">]</span></span></code></pre>
<p>If the script query the last file, it might happen that is not fully written by that time.</p>
<p>Split it into chunks of one second and for each chunk run the prediction:</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#C792EA">def</span><span style="color:#82AAFF"> has_bark_in_minute</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">filename</span><span style="color:#89DDFF">):</span></span>
<span class="line"><span style="color:#BABED8">    model </span><span style="color:#89DDFF">=</span><span style="color:#BABED8"> joblib</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">load</span><span style="color:#89DDFF">(</span><span style="color:#89DDFF">'</span><span style="color:#C3E88D">lr.pkl</span><span style="color:#89DDFF">'</span><span style="color:#89DDFF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8">    audio_data</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> __ </span><span style="color:#89DDFF">=</span><span style="color:#82AAFF"> load_audio_from_file</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">filename</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">    chunks </span><span style="color:#89DDFF">=</span><span style="color:#82AAFF"> split_in_one_second_chunks</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">audio_data</span><span style="color:#89DDFF">,</span><span style="color:#82AAFF"> sample_rate</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">    chunk_predictions </span><span style="color:#89DDFF">=</span><span style="color:#89DDFF"> []</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">    for</span><span style="color:#BABED8"> chunk </span><span style="color:#89DDFF;font-style:italic">in</span><span style="color:#BABED8"> chunks</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">        if</span><span style="color:#82AAFF"> len</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">chunk</span><span style="color:#89DDFF">)</span><span style="color:#89DDFF"> ==</span><span style="color:#BABED8"> sample_rate</span><span style="color:#89DDFF">:</span></span>
<span class="line"><span style="color:#BABED8">            mfccs </span><span style="color:#89DDFF">=</span><span style="color:#82AAFF"> extract_mfcc</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">chunk</span><span style="color:#89DDFF">)</span></span>
<span class="line"><span style="color:#BABED8">            chunk_predictions</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">append</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">model</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">predict</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">np</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">array</span><span style="color:#89DDFF">([</span><span style="color:#82AAFF">mfccs</span><span style="color:#89DDFF">]))[</span><span style="color:#F78C6C">0</span><span style="color:#89DDFF">])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic">    return</span><span style="color:#BABED8"> chunk_predictions</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">count</span><span style="color:#89DDFF">(</span><span style="color:#F78C6C">1</span><span style="color:#89DDFF">)</span><span style="color:#89DDFF"> ></span><span style="color:#F78C6C"> 2</span><span style="color:#89DDFF">,</span><span style="color:#BABED8"> chunk_predictions</span></span></code></pre>
<p>Since the model is probabilistic, it might happen to have false positive or negatives. In order to avoid that, the function <code>has_bark_in_minute</code> will only return <code>True</code> when more than two barks are detected for one minute.</p>
<p>Last but not least, when a bark is detected, the script will send me a message over telegram:</p>
<pre class="astro-code material-theme-palenight" style="background-color:#292D3E;color:#babed8; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#C792EA">def</span><span style="color:#82AAFF"> send_to_telegram</span><span style="color:#89DDFF">(</span><span style="color:#BABED8;font-style:italic">predictions</span><span style="color:#89DDFF">,</span><span style="color:#BABED8;font-style:italic"> filename</span><span style="color:#89DDFF">):</span></span>
<span class="line"><span style="color:#BABED8">    date </span><span style="color:#89DDFF">=</span><span style="color:#BABED8"> filename</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">split</span><span style="color:#89DDFF">(</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">-</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">)[-</span><span style="color:#F78C6C">1</span><span style="color:#89DDFF">].</span><span style="color:#82AAFF">split</span><span style="color:#89DDFF">(</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">.mp3</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">)[</span><span style="color:#F78C6C">0</span><span style="color:#89DDFF">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8">    welcome_msg </span><span style="color:#89DDFF">=</span><span style="color:#C792EA"> f</span><span style="color:#C3E88D">"Detected </span><span style="color:#F78C6C">{</span><span style="color:#BABED8">predictions</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">count</span><span style="color:#89DDFF">(</span><span style="color:#F78C6C">1</span><span style="color:#89DDFF">)</span><span style="color:#F78C6C">}</span><span style="color:#C3E88D"> barks on </span><span style="color:#F78C6C">{</span><span style="color:#BABED8">date</span><span style="color:#F78C6C">}</span><span style="color:#C3E88D">"</span></span>
<span class="line"></span>
<span class="line"><span style="color:#BABED8">    response </span><span style="color:#89DDFF">=</span><span style="color:#BABED8"> requests</span><span style="color:#89DDFF">.</span><span style="color:#82AAFF">post</span><span style="color:#89DDFF">(</span></span>
<span class="line"><span style="color:#C792EA">        f</span><span style="color:#C3E88D">"https://api.telegram.org/bot</span><span style="color:#F78C6C">{</span><span style="color:#82AAFF">get_token</span><span style="color:#89DDFF">()</span><span style="color:#F78C6C">}</span><span style="color:#C3E88D">/sendMessage"</span><span style="color:#89DDFF">,</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic">        data</span><span style="color:#89DDFF">={</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">chat_id</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">:</span><span style="color:#82AAFF"> telegram_group_id</span><span style="color:#89DDFF">,</span><span style="color:#89DDFF"> "</span><span style="color:#C3E88D">text</span><span style="color:#89DDFF">"</span><span style="color:#89DDFF">:</span><span style="color:#82AAFF"> welcome_msg</span><span style="color:#89DDFF">},</span></span>
<span class="line"><span style="color:#89DDFF">    )</span></span>
<span class="line"><span style="color:#82AAFF">    print</span><span style="color:#89DDFF">(</span><span style="color:#82AAFF">response</span><span style="color:#89DDFF">.</span><span style="color:#F07178">text</span><span style="color:#89DDFF">)</span></span></code></pre>
<p><img alt="Telegram message when a bark occurs" title="Telegram message when a bark occurs" width="868" height="600" loading="lazy" decoding="async" src="/_astro/telegram.DY3EMKC4_VtjKS.webp" ></p> </div> </article> </div>  </div> </article>  <footer class="flex justify-center items-center w-full px-16 h-28 border-t-2"> 2025 Adrian Galera
</footer> </main>    </body> </html> <script type="module">const t=()=>{function r(o,a){o.forEach(s=>{const e=document.querySelector(`aside a[href="#${s.target.id}"]`);s.isIntersecting?(e?.classList.remove("bg-slate-200","dark:bg-slate-800"),e?.classList.add("bg-indigo-600","dark:bg-indigo-700","text-white","font-bold","transition-colors","duration-200")):(e?.classList.add("bg-slate-200","dark:bg-slate-800"),e?.classList.remove("bg-indigo-600","dark:bg-indigo-700","text-white","font-bold","transition-colors","duration-200"))})}const i=document.querySelectorAll("div.prose h1, div.prose h2, div.prose h3, div.prose h4, div.prose h5, div.prose h6"),n={root:null,rootMargin:" 15% 0px 0% 0px ",threshold:1},d=new IntersectionObserver(r,n);i.forEach(o=>{d.observe(o)})};t();document.addEventListener("astro:after-swap",t);</script>