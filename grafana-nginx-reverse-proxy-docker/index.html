<!DOCTYPE html>
<!--
    Type on Strap jekyll theme v2.4.3
    Theme free for personal and commercial use under the MIT license
    https://github.com/sylhare/Type-on-Strap/blob/master/LICENSE
-->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=0.5, maximum-scale=5">

    <!-- Theme Mode-->
    
    <script>
        const isAutoTheme = true;
        document.documentElement.setAttribute('data-theme', sessionStorage.getItem('theme'))
    </script>
    

    <!-- Main JS (navbar.js, katex_init.js and masonry_init.js)-->
    <script defer src="/assets/js/main.min.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/main.css">

    <!--Favicon-->
    <link rel="shortcut icon" href="/assets/img/avatars/me-100x100.png" type="image/x-icon">

    

    <!-- KaTeX 0.15.2 -->
    
    <script defer src="/assets/js/vendor/katex.min.js"></script>
    <script defer src="/assets/js/vendor/auto-render.min.js" onload="renderMathInElement(document.body);"></script>
    

    <!-- Mermaid 9.1.1 -->
    
    <script defer src="/assets/js/vendor/mermaid.min.js" onload="mermaid.initialize({
      startOnLoad:true,
      theme: 'default',
    });"></script>
    

    <!-- Simple Jekyll Search 1.10.0 -->
    <script src="/assets/js/vendor/simple-jekyll-search.min.js" type="text/javascript"></script>

    <!-- Google Analytics / Cookie Consent -->
    <script>
      const cookieName = 'cookie-notice-dismissed-https://www.agalera.eu';
      const isCookieConsent = 'false';
      const analyticsName = 'UA-126206451-1';
      const analyticsNameGA4 = '';
    </script>

    
    
        <!-- Global site tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-126206451-1"></script>
        <!-- Page analysis (analytics.js) -->
        <script async src='https://www.google-analytics.com/analytics.js'></script>
        <script>
        // disable GA for localhost
        const isProduction = window.location.host.includes("agalera.eu")
        if (!isProduction) { 
          console.log(`Disabling google analytics for UA-126206451-1`)
          window['ga-disable-UA-126206451-1'] = true;
        }
        </script>
    

    <!-- seo tags -->
    <meta property="og:image" content="https://www.agalera.eu/assets/img/posts/grafana/featured.jpg">
    
    <meta property="og:type" content="website" />
    
    <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Grafana, nginx reverse-proxy and Docker | Adrian Galera blog</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Grafana, nginx reverse-proxy and Docker" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Deploy Grafana using Docker and nginx as reverse-proxy providing health-check and more advanced features such as blocking requests." />
<meta property="og:description" content="Deploy Grafana using Docker and nginx as reverse-proxy providing health-check and more advanced features such as blocking requests." />
<link rel="canonical" href="https://www.agalera.eu/grafana-nginx-reverse-proxy-docker/" />
<meta property="og:url" content="https://www.agalera.eu/grafana-nginx-reverse-proxy-docker/" />
<meta property="og:site_name" content="Adrian Galera blog" />
<meta property="og:image" content="https://www.agalera.eu/assets/img/posts/grafana/featured.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-06-15T00:00:00+02:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://www.agalera.eu/assets/img/posts/grafana/featured.jpg" />
<meta property="twitter:title" content="Grafana, nginx reverse-proxy and Docker" />
<script type="application/ld+json">
{"@type":"BlogPosting","description":"Deploy Grafana using Docker and nginx as reverse-proxy providing health-check and more advanced features such as blocking requests.","image":"https://www.agalera.eu/assets/img/posts/grafana/featured.jpg","headline":"Grafana, nginx reverse-proxy and Docker","dateModified":"2019-06-15T00:00:00+02:00","datePublished":"2019-06-15T00:00:00+02:00","url":"https://www.agalera.eu/grafana-nginx-reverse-proxy-docker/","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.agalera.eu/grafana-nginx-reverse-proxy-docker/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <!-- RSS -->
    <link rel="alternate" type="application/atom+xml" title="Adrian Galera blog" href="https://www.agalera.eu/feed.xml"/>
    <link type="application/atom+xml" rel="alternate" href="https://www.agalera.eu/feed.xml" title="Adrian Galera blog" />

    <!-- Twitter Cards -->
    <meta name="twitter:title" content="Grafana, nginx reverse-proxy and Docker">
    <meta name="twitter:description" content="We want to start monitoring our AWS resources using Cloudwatch. The API is awesome, however its visualisation tool sucks, that's why we choose Grafana to pre...">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https://www.agalera.eu/assets/img/posts/grafana/featured.jpg">
    <meta name="twitter:image:alt" content="Grafana, nginx reverse-proxy and Docker">
</head>

  <body>
    <header class="site-header">

    <!-- Logo and title -->
	<div class="branding">
        
		<a href="/">
			<img alt="logo img" class="avatar" src="/assets/img/avatars/me-100x100.png" />
		</a>
        
        <a class="site-title" aria-label="Adrian Galera blog" href="/">
        Adrian Galera blog
		</a>
	</div>

    <!-- Toggle menu -->
    <nav class="clear">
    <a aria-label="pull" id="pull" class="toggle" href="#">
    <i class="fas fa-bars fa-lg"></i>
    </a>

    <!-- Menu -->
    <ul class="hide">
        

        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Search" title="Search" href="/search/">
                     <i class="fas fa-search" aria-hidden="true"></i>
                    
                </a>
            </li>
            
            
        
            
            <li class="separator"> | </li>
            <li>
                <a class="clear" aria-label="Tags" title="Tags" href="/tags/">
                     <i class="fas fa-tags" aria-hidden="true"></i>
                    
                </a>
            </li>
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
        
        
        <li class="separator"> | </li>
        <li><a id="theme-toggle" title="Grafana, nginx reverse-proxy and Docker " aria-label="Grafana, nginx reverse-proxy and Docker" onclick="themeToggle()"></a></li>
        
    </ul>

	</nav>
</header>

    <div class="content">
      <article class="feature-image" >
  <header id="main" style="">
    <div class="title-padder">
      
      <h1 id="Grafana%2C+nginx+reverse-proxy+and+Docker" class="title">Grafana, nginx reverse-proxy and Docker</h1>
      


<div class="post-info">
    <p class="meta">
      
      
      June 15, 2019
    </p></div>

      
    </div>
  </header>

  <section class="post-content">
  
      <p>We want to start monitoring our AWS resources using Cloudwatch. The API is awesome, however its visualisation tool sucks, that's why we choose Grafana to present the data.</p>
<p><!--more--></p>
<p>Currently, we're using ECS to deploy our services and Grafana is available as a Docker image therefore this tool is a natural fit! We checked the documentation and everything looks fine: <a href="https://grafana.com/docs/installation/docker/">https://grafana.com/docs/installation/docker</a></p>
<p>The problem comes when we tried to deploy Grafana docker image using our governance tool. This tool expects a <em>/health-check </em>endpoint to detect the status of our applications. Here we have two approaches:</p>
<ul>
<li>Try to modify the Grafana code to add this logic inside</li>
<li>Add something to the Docker container to answer this endpoint.</li>
</ul>
<p>For obvious reasons we chose the second version. Initially we were thinking on some kind of script. However we realised that the requests to Grafana need to be proxied. This is even mentioned in their documentation! <a href="https://grafana.com/docs/installation/behind_proxy/">https://grafana.com/docs/installation/behind_proxy/</a> .</p>
<h5>The solution</h5>
<p>Now that we have discarded the scripting, we chose nginx to implement the reverse proxy and we delegate the health-check endpoint to a static content under webroot of nginx.</p>
<p>Hereunder is the Dockerfile, which is self-explanatory:</p>

<div class="language-docker highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> grafana/grafana</span>
<span class="k">EXPOSE</span><span class="s"> 8080 8080</span>
<span class="k">COPY</span><span class="s"> health-check /health-check</span>
<span class="k">COPY</span><span class="s"> start-nginx-grafana.sh /start-nginx-grafana.sh</span>
<span class="k">USER</span><span class="s"> root</span>
<span class="k">RUN </span>apt-get update &amp;amp<span class="p">;</span>&amp;amp<span class="p">;</span> apt-get <span class="nb">install</span> <span class="nt">-y</span> nginx
<span class="k">RUN </span><span class="nb">chown</span> <span class="nt">-R</span> grafana:grafana /etc/nginx/nginx.conf /var/log/nginx /var/lib/nginx /start-nginx-grafana.sh
<span class="k">RUN </span><span class="nb">chmod</span> +x /start-nginx-grafana.sh
<span class="k">USER</span><span class="s"> grafana</span>
<span class="k">RUN </span><span class="nb">cp</span> /health-check/nginx.conf /etc/nginx/nginx.conf
<span class="k">ENTRYPOINT</span><span class="s"> [ "/start-nginx-grafana.sh" ]</span>
</code></pre></div></div>

<p>The tricky part we found was that installing nginx required sudo permissions, however this could be easily achieved changing to the user root in the Dockerfile. Grafana service runs as grafana user, so, some permissions of files and folders of the nginx services need to be changed to the grafana user.</p>
<p>The following snippet shows the nginx.conf file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>worker_processes  1;
pid /var/lib/nginx/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;
    server {
        listen       8080;
        server_name  localhost;

        location /health-check {
            default_type  "application/json";
            root   /health-check;
            index  health-check.json;
        }

        location / {
            proxy_pass http://localhost:3000/;
        }

        #location /api {
        #    return 403;
        #}
    }
}
</code></pre></div></div>

<p>This configuration enables the health-check endpoint to be compatible with our governance tool. Precisely nginx returns the file health-check.json in response to this endpoint. nginx proxies any other request to the Grafana instance running inside the container. The presence of the nginx reverse proxy enables the user to implement more features, like blocking the Grafana API, etc...</p>
<p>You can check the code to provide Grafana,nginx and Docker here: <a href="https://github.com/adriangalera/nginx-grafana-docker">https://github.com/adriangalera/nginx-grafana-docker</a></p>

    
  </section>

  <!-- Social media shares -->
  

<div class="share-buttons">
    <ul class="share-buttons">
        <li class="meta">Share</li>
        
        <li>
            <a href="https://www.facebook.com/sharer/sharer.php?u=https://www.agalera.eu/grafana-nginx-reverse-proxy-docker/" target="_blank"
               title=" Facebook">
                <i class="fab fa-facebook-square fa-2x" aria-hidden="true"></i>
                <span class="sr-only">Share on Facebook</span>
            </a>
        </li>
         
        <li>
            <a href="https://twitter.com/intent/tweet?text=Grafana%2C+nginx+reverse-proxy+and+Docker%20https%3A%2F%2Fwww.agalera.eu%2Fgrafana-nginx-reverse-proxy-docker%2F"
               target="_blank" title="">
                <i class="fab fa-twitter-square fa-2x" aria-hidden="true"></i>
                <span class="sr-only">Tweet</span>
            </a>
        </li>
         
        <li>
            <a href="https://www.tumblr.com/share?v=3&u=https://www.agalera.eu/grafana-nginx-reverse-proxy-docker/&quote=Grafana%2C+nginx+reverse-proxy+and+Docker%20%7C%20Adrian+Galera+blog&s="
               target="_blank" title=" Tumblr">
                <i class="fab fa-tumblr-square fa-2x" aria-hidden="true"></i>
                <span class="sr-only">Share on Tumblr</span>
            </a>
        </li>
         
        <li>
            <a href="https://pinterest.com/pin/create/button/?url=https://www.agalera.eu/grafana-nginx-reverse-proxy-docker/&media=https://www.agalera.eu/assets/img/posts/grafana/featured.jpg$description=We+want+to+start+monitoring+our+AWS+resources+using+Cloudwatch.+The+API+is+awesome%2C+however+its+visualisation+tool+sucks%2C+that%27s+why+we+choose+Grafana+to+present+the+data.%0A%0A%0A"
               target="_blank" title="">
                <i class="fab fa-pinterest-square fa-2x" aria-hidden="true"></i>
                <span class="sr-only">Pin it</span>
            </a>
        </li>
          
        <li>
            <a href="https://www.reddit.com/submit?url=https://www.agalera.eu/grafana-nginx-reverse-proxy-docker/&title=Grafana%2C+nginx+reverse-proxy+and+Docker%20%7C%20Adrian+Galera+blog"
               target="_blank" title=" Reddit">
                <i class="fab fa-reddit-square fa-2x" aria-hidden="true"></i>
                <span class="sr-only">Share on Reddit</span>
            </a>
        </li>
         
        <li>
            <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://www.agalera.eu/grafana-nginx-reverse-proxy-docker/&title=Grafana%2C+nginx+reverse-proxy+and+Docker%20%7C%20Adrian+Galera+blog&summary=&source=https://www.agalera.eu/grafana-nginx-reverse-proxy-docker/"
               target="_blank" title=" LinkedIn">
                <i class="fab fa-linkedin fa-2x" aria-hidden="true"></i>
                <span class="sr-only">Share on LinkedIn</span>
            </a>
        </li>
          
        <li>
            <a href="mailto:?subject=Grafana, nginx reverse-proxy and Docker%20%7C%20Adrian Galera blog&body=https://www.agalera.eu/grafana-nginx-reverse-proxy-docker/"
               target="_blank" title="">
                <i class="fas fa-envelope-square fa-2x" aria-hidden="true"></i>
                <span class="sr-only">Email</span></a>
        </li>
        
    </ul>
</div>




   <!-- Tag list -->
  
  


  <div class="tag-list">
    <ul>
      
        <li class="meta">Tags</li>
      

      
        <li><a class="button" href="/tags#devops">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> devops</p>
        </a></li>
      
        <li><a class="button" href="/tags#docker">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> docker</p>
        </a></li>
      
        <li><a class="button" href="/tags#grafana">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> grafana</p>
        </a></li>
      
        <li><a class="button" href="/tags#nginx">
          <p><i class="fas fa-tag fa-fw fa-sm"></i> nginx</p>
        </a></li>
      
    </ul>
  </div>



</article>

<!-- Post navigation -->

<div id="post-nav">
    
    <div id="previous-post">
        <a alt="Java Unit Test to check UTF-8 chars" href="/java-test-utf8/">
            <p>Previous post</p>
            Java Unit Test to check UTF-8 chars
        </a>
    </div>
    

    
    <div id="next-post">
        <a alt="Parse huge local json file" href="/parse-huge-local-json-file/">
            <p>Next post</p>
            Parse huge local json file
        </a>
    </div>
    
</div>



<!--Utterances-->


<!-- Cusdis -->


<!-- Disqus -->


<!-- To change color of links in the page -->
<style>
  header#main {
      background-size: cover;
      background-repeat: no-repeat;
      background-position: center;
  }

  

  
  header#main { background-image: url('/assets/img/posts/grafana/featured.jpg'); }
  
</style>

    </div>
    <footer class="site-footer">
    <p class="text">
        </p>
            <div class="footer-icons">
                <ul>
                <!-- Social icons from Font Awesome, if enabled -->
                
<li>
    <a feed.xml href="/feed.xml"
       title="Follow RSS feed"
       target="_blank">
        <span class="fa-stack fa-lg">
            <i class="fas fa-circle fa-stack-2x"></i>
            <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
        </span>
    </a>
</li>



    

    

    

    

    

    

    
        
        
        
        
        <li>
            <a href="https://github.com/adriangalera"
               title="Follow on Github"
               target="_blank"
               rel="noopener">
            <span class="fa-stack fa-lg">
              <i class="fas fa-circle fa-stack-2x"></i>
              <i class="fab fa-github fa-stack-1x fa-inverse"></i>
            </span>
            </a>
        </li>
    

    

    

    

    

    

    
        
        
        
        
        <li>
            <a href="https://www.linkedin.com/in/adriangalera"
               title="Follow on Linkedin"
               target="_blank"
               rel="noopener">
            <span class="fa-stack fa-lg">
              <i class="fas fa-circle fa-stack-2x"></i>
              <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
            </span>
            </a>
        </li>
    

    
        
        
        
        
        <li>
            <a href="mailto:adrian.galera.87@gmail.com"
               title="Follow on Mail"
               target="_blank"
               rel="noopener">
            <span class="fa-stack fa-lg">
              <i class="fas fa-circle fa-stack-2x"></i>
              <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
            </span>
            </a>
        </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    


                </ul>
            </div>
</footer>



  </body>
</html>
